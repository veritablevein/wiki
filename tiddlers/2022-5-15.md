> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [juejin.cn](https://juejin.cn/post/7055202073511460895)

ã€Œè¿™æ˜¯æˆ‘å‚ä¸ 2022 é¦–æ¬¡æ›´æ–‡æŒ‘æˆ˜çš„ç¬¬ 3 å¤©ï¼Œæ´»åŠ¨è¯¦æƒ…æŸ¥çœ‹ï¼š[2022 é¦–æ¬¡æ›´æ–‡æŒ‘æˆ˜](https://juejin.cn/post/7052884569032392740 "https://juejin.cn/post/7052884569032392740")ã€

å†™åœ¨å‰é¢çš„è¯
------

**é˜…è¯»æœ¬æ–‡ä½ å°†æ”¶è·ä»€ä¹ˆï¼Ÿ**

*   äº†è§£ V8 Promise æºç å…¨è¿‡ç¨‹ï¼Œä¸–ç•Œä¸Šä¸å†æœ‰èƒ½å›°ä½ä½ çš„ Promise é¢˜ç›®ï¼Œæˆ‘å°±æ˜¯è¿™ä¹ˆè‚¯å®šè¿™ç¯‡æ–‡ç« çš„å¹²è´§
*   ä»…ä»…äº†è§£æˆ–è€…å®ç°äº† Promise/A+ è§„èŒƒï¼Œè¿™ä¸ JavaScript çš„ Promise ä¸­é—´è¿˜æœ‰å¾ˆå¤§çš„å·®è·
*   å¦‚æœä½ åœ¨é¢è¯•æ—¶å°† Promise å›ç­”åˆ°æœ¬æ–‡çš„æ·±åº¦ï¼Œä¸€å®šæ˜¯æ”¶è· SP æˆ–è€… SSP offer çš„åˆ©å™¨ï¼Œå› ä¸ºé¢è¯•å®˜å¤§æ¦‚ç‡ä¹Ÿä¸çŸ¥é“è¿™äº›çŸ¥è¯†ã€‚

ä½ çŸ¥é“ æµè§ˆå™¨ & Node ä¸­çœŸæ­£çš„ `Promise` æ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ ·çš„å—ï¼Œå¦‚æœä½ åªæ˜¯çœ‹è¿‡ `Promise/A+` è§„èŒƒçš„ `Promise` å®ç°ï¼Œé‚£ä¹ˆæˆ‘è‚¯å®šçš„å‘Šè¯‰ä½ ï¼Œä½ å¯¹ `Promise` æ‰§è¡Œé¡ºåºçš„è®¤çŸ¥æ˜¯é”™è¯¯çš„ã€‚ä¸ä¿¡çš„è¯ä½ å°±çœ‹çœ‹ä¸‹é¢è¿™ä¸¤é“é¢˜ã€‚

```
Promise.resolve().then(() => {
    console.log(0);
    return Promise.resolve(4)
}).then(res => {
    console.log(res);
})

Promise.resolve().then(() => {
    console.log(1);
}).then(() => {
    console.log(2);
}).then(() => {
    console.log(3);
}).then(() => {
    console.log(5);
}).then(() => {
    console.log(6);
})
// 0 1 2 3 4 5 6


new Promise((resolve, reject) => {
    Promise.resolve().then(() => {
        resolve({
            then: (resolve, reject) => resolve(1)
        });
        Promise.resolve().then(() => console.log(2));
    });
}).then(v => console.log(v));
// 2 1
å¤åˆ¶ä»£ç 
```

æŒ‰ç…§ `Promise/A+` è§„èŒƒæ¥è¯´ï¼Œä¸Šé¢çš„ä»£ç æ‰“å°çš„ç»“æœåº”è¯¥æ˜¯ 0 1 2 4 3 5 6ï¼Œå› ä¸ºå½“ `then` è¿”å›ä¸€ä¸ª `Promise` çš„æ—¶å€™éœ€è¦ç­‰å¾…è¿™ä¸ª `Promise` å®Œæˆåå†åŒæ­¥çŠ¶æ€å’Œå€¼ç»™ `then` çš„ç»“æœã€‚

ä½†æ˜¯åœ¨ `V8` ç”šè‡³ å„å¤§æ”¯æŒ `Promise` çš„ä¸»æµæµè§ˆå™¨ä¸­çš„æ‰§è¡Œç»“æœéƒ½æ˜¯ 0 1 2 3 4 5 6

> ä»–ä»¬æ˜¯å¦‚ä½•åšåˆ°ä¸ `Promise/A+` è§„èŒƒä¸ä¸€æ ·ï¼ˆä¹Ÿä¸èƒ½è¯´ä¸€æ ·ï¼Œå› ä¸º `Promise` æ²¡æœ‰æ˜ç¡®æè¿°ä»–ä»¬çš„æ‰§è¡Œé€»è¾‘ï¼Œåªæ˜¯ç»™å‡ºä¸€äº›è§„èŒƒï¼‰ä¸”ä¿æŒä¸€è‡´çš„ï¼Ÿ

è¦çŸ¥é“ï¼Œ `Promise` å±äº `JavaScript` ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œ è€Œ `JavaScript` ä¸­ `Promise` çš„å®ç°è§„èŒƒå¹¶éæ¥æºäº `Promise/A+`ï¼Œè€Œæ˜¯æ¥è‡ª `ECMAScript` è§„èŒƒã€‚

æ‰€ä»¥è¦çŸ¥é“è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ‘ä»¬ä¸èƒ½ä»…ä»…çœ‹ `Promise/A+` ï¼Œå¯¹äºä»£ç çš„æ‰§è¡Œè¿‡ç¨‹å’Œé¡ºåºæˆ‘ä»¬çš„å…³æ³¨ç‚¹åº”è¯¥æ˜¯åœ¨ `ECMAScript` æˆ–è€… `V8` ä¸Šã€‚

æ¥ä¸‹æ¥æˆ‘å°±ç»“åˆ `ECMAScript` è§„èŒƒæ¥å¯¹ `V8` ä¸­ `Promise` æºç è¿›è¡Œå…¨é¢çš„è§£è¯»ã€‚

**è¿˜æœ‰ä¸‰ä»¶äº‹éœ€è¦æå‰è¯´ä¸€ä¸‹:**

1.  æœ¬æ–‡æ›´åŠ é€‚åˆæœ‰ä¸€å®š Promise åŸºç¡€çš„åŒå­¦é˜…è¯»ï¼Œå¦‚æœå¯¹ Promise ä¸äº†è§£çš„åŒå­¦å¯ä»¥å…ˆçœ‹çœ‹è¿™äº›æ–‡ç« 
    *   [ã€ç¿»è¯‘ã€‘promise](https://juejin.cn/post/7054931900074295310#heading-7 "https://juejin.cn/post/7054931900074295310#heading-7")
    *   [Promise ä¸ä¼šï¼Ÿï¼Ÿçœ‹è¿™é‡Œï¼ï¼ï¼å²ä¸Šæœ€é€šä¿—æ˜“æ‡‚çš„ Promiseï¼ï¼ï¼](https://juejin.cn/post/6844903607968481287 "https://juejin.cn/post/6844903607968481287")
2.  å¯¹äºåç»­è´´å‡ºçš„ c++ ä»£ç å¤§å®¶åªéœ€è¦ç€é‡çœ‹å¸¦æœ‰ä¸­æ–‡æ³¨é‡Šçš„åœ°æ–¹å³å¯
3.  å› ä¸ºä»£ç å—ä¸ä¼šè‡ªåŠ¨æ¢è¡Œï¼Œæ‰€ä»¥å»ºè®® PC ç«¯é˜…è¯»å¯ä»¥æœ‰æ›´å¥½çš„é˜…è¯»ä½“éªŒ
4.  æ–‡ç« å¾ˆé•¿ï¼Œå¯ä»¥æ”¶è—ï¼Œæœ‰æ—¶é—´é™ä¸‹å¿ƒæ¥æ…¢æ…¢çœ‹ä¹Ÿå¯ä»¥ã€‚
5.  ç‚¹èµğŸ‘ğŸ»ã€ç‚¹èµğŸ‘ğŸ»ã€ç‚¹èµğŸ‘ğŸ»

è¿›å…¥æ­£é¢˜

PromiseState
------------

Promise çš„ 3 ç§çŠ¶æ€ï¼Œ`pending`ã€ `fulfilled` å’Œ `rejected` ï¼Œ[æºç å¦‚ä¸‹](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fbase.tq%2523190 "https://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/base.tq%23190")ï¼š

```
// Promise constants
extern enum PromiseState extends int31 constexpr 'Promise::PromiseState' {
  kPending,// ç­‰å¾…çŠ¶æ€
  kFulfilled,// æˆåŠŸçŠ¶æ€
  kRejected// å¤±è´¥çŠ¶æ€
}
å¤åˆ¶ä»£ç 
```

ä¸€ä¸ªæ–°åˆ›å»ºçš„ `Promise` å¤„äº `pending` çŠ¶æ€ã€‚å½“è°ƒç”¨ `resolve` æˆ– `reject` å‡½æ•°åï¼Œ`Promise` å¤„äº `fulfilled` æˆ– `rejected` çŠ¶æ€ï¼Œæ­¤å `Promise` çš„çŠ¶æ€ä¿æŒä¸å˜ï¼Œä¹Ÿå°±æ˜¯è¯´ `Promise` çš„çŠ¶æ€æ”¹å˜æ˜¯ä¸å¯é€†çš„ï¼Œå¦‚æœå†æ¬¡è°ƒç”¨ `resolve` æˆ–è€… `reject` å°†ä¸ä¼šå‘ç”Ÿä»»ä½•äº‹ï¼Œ`Promise` æºç ä¸­å‡ºç°äº†å¤šå¤„çŠ¶æ€ç›¸å…³çš„ assertï¼ˆæ–­è¨€ï¼‰ï¼Œè¿™ä¸ªå°±ä¸èµ˜è¿°äº†ï¼Œæƒ³å¿…å¯¹äº `Promise` çš„ä¸‰ç§çŠ¶æ€å¤§å®¶éƒ½æ¯”è¾ƒç†Ÿæ‚‰äº†ã€‚

### JSPromise

JSPromise æè¿° `Promise` çš„åŸºæœ¬ä¿¡æ¯ï¼Œ[æºç å¦‚ä¸‹](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fobjects%2Fjs-promise.tq%252313 "https://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/objects/js-promise.tq%2313")ï¼š

```
bitfield struct JSPromiseFlags extends uint31 {
  // Promise çš„çŠ¶æ€ï¼ŒkPending/kFulfilled/kRejected
  status: PromiseState: 2 bit; 
  // æ˜¯å¦æœ‰onFulfilled/onRejectedå¤„ç†å‡½æ•°ï¼Œ
  // æ²¡æœ‰è°ƒç”¨è¿‡ then æ–¹æ³•çš„ Promise æ²¡æœ‰å¤„ç†å‡½æ•°
  //ï¼ˆcatchæ–¹æ³•çš„æœ¬è´¨æ˜¯thenæ–¹æ³•ï¼Œåé¢ä¼šä»‹ç»ï¼‰
  has_handler: bool: 1 bit; 
  handled_hint: bool: 1 bit; 
  async_task_id: int32: 22 bit;
}

@generateCppClass
extern class JSPromise extends JSObject {
  macro Status(): PromiseState {
    // è·å– Promise çš„çŠ¶æ€ï¼Œè¿”å› 
    // kPending/kFulfilled/kRejected ä¸­çš„ä¸€ä¸ª
    return this.flags.status;
  }

  macro SetStatus(status: constexpr PromiseState): void {
    // åªæœ‰ pending çŠ¶æ€çš„ Promise æ‰å¯ä»¥è¢«æ”¹å˜çŠ¶æ€
    assert(this.Status() == PromiseState::kPending);
    // Promise åˆ›å»ºæˆåŠŸåï¼Œä¸å¯å°† Promise è®¾ç½®ä¸º pending çŠ¶æ€
    assert(status != PromiseState::kPending);
    this.flags.status = status;
  }

  macro HasHandler(): bool {
    // åˆ¤æ–­ Promise æ˜¯å¦æœ‰å¤„ç†å‡½æ•°
    return this.flags.has_handler;
  }

  macro SetHasHandler(): void {
    this.flags.has_handler = true;
  }

  // promise å¤„ç†å‡½æ•°æˆ–ç»“æœï¼Œå¯ä»¥æ˜¯:
  // ç©º
  // onFulfilled/onRejectedæ„æˆçš„é“¾è¡¨
  // promiseçš„ç¡®è®¤å€¼ï¼ˆresolveçš„å‚æ•°ï¼‰
  reactions_or_result: Zero|PromiseReaction|JSAny;
  flags: SmiTagged<JSPromiseFlags>;
}
å¤åˆ¶ä»£ç 
```

å½“ `Promise` çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ¯”å¦‚è°ƒç”¨äº† `resolve/reject` å‡½æ•°ï¼Œ`SetStatus` æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼›`Javascript` å±‚è°ƒç”¨ `resolve` æ–¹æ³•æ—¶ï¼Œ`reactions_or_result` å­—æ®µä¼šè¢«èµ‹å€¼ä¸º `resolve` ä¼ å…¥çš„å‚æ•°ï¼›`Javascript` å±‚è°ƒç”¨ `then` æ–¹æ³•æ—¶ï¼Œè¯´æ˜å·²ç»æœ‰äº†å¤„ç†å‡½æ•°ï¼Œ`SetHasHandler()` ä¼šè¢«è°ƒç”¨ã€‚`Status/SetStatus` è¿™ä¸¤ä¸ªæ–¹æ³•ä¸€ä¸ªè·å– `Promise` çŠ¶æ€ï¼Œä¸€ä¸ªè®¾ç½® `Promise` çŠ¶æ€ï¼›

### å…¶å®ƒ

*   executorï¼šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ`Promise` æ„é€ å‡½æ•°æ¥æ”¶çš„å‚æ•°ï¼Œè°ƒç”¨ `executor` æ—¶ä¼ å…¥çš„å‚æ•°åˆ†åˆ«æ˜¯ `resolve` å’Œ `reject`ã€‚
*   PromiseReactionï¼šæ˜¯å¯¹è±¡ï¼Œè¡¨ç¤º `Promise` çš„å¤„ç†å‡½æ•°ï¼Œå› ä¸ºä¸€ä¸ª `Promise` å¤šæ¬¡è°ƒç”¨ `then` æ–¹æ³•å°±ä¼šæœ‰å¤šä¸ªå¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥åº•å±‚æ•°æ®ç»“æ„æ˜¯ä¸ªé“¾è¡¨ï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½å­˜å‚¨ç€ `onFulfilled` å’Œ `onRejected` å‡½æ•°ã€‚

```
let p = new Promise((resolve, reject) => {
  resolve(123)
  // ä¼šå°† reactions_or_result è®¾ç½®ä¸º 123
  // ä¼šè°ƒç”¨ SetHasHandler
  resolve(234)// ä¸ä¼šå‘ç”Ÿä»»ä½•äº‹ï¼Œç›¸å½“äºæ²¡å†™
  reject(234)// ä¹Ÿä¸ä¼šå‘ç”Ÿä»»ä½•äº‹ï¼Œç›¸å½“äºæ²¡å†™
})
å¤åˆ¶ä»£ç 
```

æ„é€ å‡½æ•°
----

æ„é€ å‡½æ•°[æºç å¦‚ä¸‹](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-constructor.tq%252347 "https://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-constructor.tq%2347")ï¼š

```
PromiseConstructor(
    js-implicit context: NativeContext, receiver: JSAny,
    newTarget: JSAny)(executor: JSAny): JSAny {
  // 1. å¦‚æœä¸å­˜åœ¨ new å…³é”®å­—, throw a TypeError exception.
  if (newTarget == Undefined) {
    ThrowTypeError(MessageTemplate::kNotAPromise, newTarget);
  }

  // 2. å¦‚æœä¼ å…¥çš„å‚æ•°ä¸æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°, throw a TypeError exception.
  if (!Is<Callable>(executor)) {
    ThrowTypeError(MessageTemplate::kResolverNotAFunction, executor);
  }

  let result: JSPromise;
  // æ„é€ ä¸€ä¸ª Promise å¯¹è±¡
  result = NewJSPromise();
  // ä» Promise å¯¹è±¡èº«ä¸Šï¼Œè·å–å®ƒçš„ resolve å’Œ reject å‡½æ•°
  const funcs = CreatePromiseResolvingFunctions(result, True, context);
  const resolve = funcs.resolve;
  const reject = funcs.reject;
  try {
    // ç›´æ¥åŒæ­¥è°ƒç”¨ executor å‡½æ•°ï¼Œresolve å’Œ reject åšä¸ºå‚æ•°
    Call(context, UnsafeCast<Callable>(executor), Undefined, resolve, reject);
  } catch (e) {
    // å¦‚æœå‡ºç°å¼‚å¸¸åˆ™è°ƒç”¨ reject å‡½æ•°
    Call(context, reject, Undefined, e);
  }
  return result;
}
å¤åˆ¶ä»£ç 
```

é¦–å…ˆåˆ†æä¸¤ä¸ª `ThrowTypeError`ï¼Œä»¥ä¸‹ä»£ç å¯è§¦å‘ç¬¬ä¸€ä¸ª `ThrowTypeError`ã€‚

```
Promise()  // Uncaught TypeError: undefined is not a promise
å¤åˆ¶ä»£ç 
```

åŸå› æ˜¯æ²¡æœ‰ä½¿ç”¨ `new` æ“ä½œç¬¦è°ƒç”¨ `Promise` æ„é€ å‡½æ•°ï¼Œæ­¤æ—¶ `newTarget` ç­‰äº `Undefined`ï¼Œè§¦å‘äº† `ThrowTypeError(MessageTemplate::kNotAPromise, newTarget)`ã€‚

ä»¥ä¸‹ä»£ç å¯è§¦å‘ç¬¬äºŒä¸ª `ThrowTypeError`ã€‚

```
new Promise() // Uncaught TypeError: Promise resolver undefined is not a function
å¤åˆ¶ä»£ç 
```

æ­¤æ—¶ `newTarget` ä¸ç­‰äº `Undefined`ï¼Œä¸ä¼šè§¦å‘ç¬¬ä¸€ä¸ª `ThrowTypeError`ã€‚ä½†è°ƒç”¨ `Promise` æ„é€ å‡½æ•°æ—¶æ²¡ä¼ å‚æ•° `executor`ï¼Œè§¦å‘äº†ç¬¬äºŒä¸ª `ThrowTypeError`ã€‚

`executor` çš„ç±»å‹æ˜¯å‡½æ•°ï¼Œåœ¨ JavaScript çš„ä¸–ç•Œé‡Œï¼Œå›è°ƒå‡½æ•°é€šå¸¸æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œä½† `executor` æ˜¯åŒæ­¥è°ƒç”¨ã€‚åœ¨ `Call(context, UnsafeCast(executor), Undefined, resolve, reject)` è¿™ä¸€è¡Œï¼ŒåŒæ­¥è°ƒç”¨äº† `executor`ã€‚

```
console.log('åŒæ­¥æ‰§è¡Œå¼€å§‹')
new Promise((resolve, reject) => {
  resolve()
  console.log('executor åŒæ­¥æ‰§è¡Œ')
})

console.log('åŒæ­¥æ‰§è¡Œç»“æŸ')
// æœ¬æ®µä»£ç çš„æ‰“å°é¡ºåºæ˜¯:
// åŒæ­¥æ‰§è¡Œå¼€å§‹
// executor åŒæ­¥æ‰§è¡Œ
// åŒæ­¥æ‰§è¡Œç»“æŸ
å¤åˆ¶ä»£ç 
```

> Promise æ„é€ å‡½æ•°æ¥æ”¶çš„å‚æ•° `executor`ï¼Œæ˜¯è¢«åŒæ­¥è°ƒç”¨çš„

then
----

[ECMAScript è§„èŒƒ](https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-promise.prototype.then "https://262.ecma-international.org/11.0/#sec-promise.prototype.then")

### PromisePrototypeThen

`Promise` çš„ `then` æ–¹æ³•ä¼ å…¥ä¸¤ä¸ªå›è°ƒå‡½æ•° `onFulfilled` å’Œ `onRejected`ï¼Œåˆ†åˆ«ç”¨äºå¤„ç† `fulfilled` å’Œ `rejected` çŠ¶æ€ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ `Promise`ã€‚

JavaScript å±‚çš„ `then` å‡½æ•°å®é™…ä¸Šæ˜¯ `V8` ä¸­çš„ `PromisePrototypeThen` å‡½æ•°ï¼Œ[æºç å¦‚ä¸‹](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-then.tq%252321 "https://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-then.tq%2321")ï¼š

```
PromisePrototypeThen(js-implicit context: NativeContext, receiver: JSAny)(
    onFulfilled: JSAny, onRejected: JSAny): JSAny {
  const promise = Cast<JSPromise>(receiver) otherwise ThrowTypeError(
      MessageTemplate::kIncompatibleMethodReceiver, 'Promise.prototype.then',
      receiver);

  const promiseFun = UnsafeCast<JSFunction>(
      context[NativeContextSlot::PROMISE_FUNCTION_INDEX]);

  let resultPromiseOrCapability: JSPromise|PromiseCapability;
  let resultPromise: JSAny;
  label AllocateAndInit {
    // åˆ›å»ºä¸€ä¸ªæ–°çš„ promise ç”¨äºå½“åšæœ¬æ¬¡ then çš„è°ƒç”¨ç»“æœè¿”å›
    //ï¼ˆä¸Šé¢æœ‰æåˆ°thençš„è¿”å›å€¼æ˜¯ä¸€ä¸ªpromiseï¼‰
    const resultJSPromise = NewJSPromise(promise);
    resultPromiseOrCapability = resultJSPromise;
    resultPromise = resultJSPromise;
  }
  // onFulfilled å’Œ onRejected æ˜¯ then æ¥æ”¶çš„ä¸¤ä¸ªå‚æ•°
  // å¦‚æœä¸ä¼ åˆ™é»˜è®¤å€¼ä¸º Undefined
  const onFulfilled = CastOrDefault<Callable>(onFulfilled, Undefined);
  const onRejected = CastOrDefault<Callable>(onRejected, Undefined);

  // è°ƒç”¨ PerformPromiseThenImpl å‡½æ•°
  PerformPromiseThenImpl(
      promise, onFulfilled, onRejected, resultPromiseOrCapability);
  // è¿”å›ä¸€ä¸ªæ–°çš„ Promise
  return resultPromise;
}
å¤åˆ¶ä»£ç 
```

`PromisePrototypeThen` å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ `Promise` å¯¹è±¡ï¼Œè·å– `then` æ¥æ”¶åˆ°çš„ä¸¤ä¸ªå‚æ•°ï¼Œè°ƒç”¨ `PerformPromiseThenImpl` å®Œæˆå¤§éƒ¨åˆ†å·¥ä½œã€‚è¿™é‡Œæœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼Œ`then` æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ `Promise`ã€‚

```
const myPromise2 = new Promise((resolve, reject) => {
  resolve('foo')
})

const myPromise3 = myPromise2.then(console.log)

// myPromise2 å’Œ myPromise3 æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡
// æœ‰ä¸åŒçš„çŠ¶æ€å’Œä¸åŒçš„å¤„ç†å‡½æ•°
console.log(myPromise2 === myPromise3) // æ‰“å° false
å¤åˆ¶ä»£ç 
```

> then æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°çš„ Promise

### PerformPromiseThenImpl

[ECMAScript è§„èŒƒ](https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-performpromisethen "https://262.ecma-international.org/11.0/#sec-performpromisethen")

`PerformPromiseThenImpl` æœ‰ 4 ä¸ªå‚æ•°ï¼Œå› ä¸º `PerformPromiseThenImpl` æ˜¯åœ¨è°ƒç”¨ `then` è°ƒç”¨ï¼Œæ‰€ä»¥å®ƒçš„å‰ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯è¢«è°ƒç”¨ `then` æ–¹æ³•çš„ `Promise` å¯¹è±¡ï¼Œä»¥åŠè¿™ä¸ª `Promise` å¯¹è±¡å³å°†è¢«ç»‘å®šçš„ä¸¤ä¸ªå¤„ç†å‡½æ•° `onFulfilled` å’Œ `onRejected`ï¼ˆå€¼å°±æ˜¯è°ƒç”¨ `then(onFulfilled, onRejected)` æ—¶ä¼ é€’çš„ä¸¤ä¸ªå‚æ•°ï¼‰ï¼Œæœ€åä¸€ä¸ªå‚æ•°ä¸ºè°ƒç”¨è¿™ä¸ª `then` è¿”å›çš„æ–° `Promise` å¯¹è±¡ `resultPromiseOrCapability`ã€‚

PerformPromiseThenImpl [æºç å¦‚ä¸‹](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-abstract-operations.tq%2523409 "https://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-abstract-operations.tq%23409")ï¼š

```
transitioning macro PerformPromiseThenImpl(implicit context: Context)(
    promise: JSPromise, 
  	onFulfilled: Callable|Undefined,
    onRejected: Callable|Undefined,
    resultPromiseOrCapability: JSPromise|PromiseCapability|Undefined): void {
  if (promise.Status() == PromiseState::kPending) {
    // pending çŠ¶æ€çš„åˆ†æ”¯
    // å¦‚æœå½“å‰ Promise è¿˜æ˜¯ pending çŠ¶æ€
    // é‚£ä¹ˆåªéœ€è¦å°†æœ¬æ¬¡ then ç»‘å®šçš„å¤„ç†å‡½æ•°å­˜å‚¨èµ·æ¥å³å¯
    const handlerContext = ExtractHandlerContext(onFulfilled, onRejected);
    // æ‹¿åˆ° Promise çš„ reactions_or_result å­—æ®µ
    const promiseReactions =
        UnsafeCast<(Zero | PromiseReaction)>(promise.reactions_or_result);
    // è€ƒè™‘ä¸€ä¸ª Promise å¯èƒ½ä¼šæœ‰å¤šä¸ª then çš„æƒ…å†µ
    // reaction æ˜¯ä¸ªé“¾è¡¨ï¼Œæ¯æ¬¡ç»‘å®šå¤„ç†å‡½æ•°éƒ½åœ¨é“¾è¡¨çš„å¤´éƒ¨æ’å…¥
    // å­˜ Promise çš„æ‰€æœ‰å¤„ç†å‡½æ•°
    const reaction = NewPromiseReaction(
        handlerContext, promiseReactions, resultPromiseOrCapability,
        onFulfilled, onRejected);
    // reactions_or_result å¯ä»¥å­˜ Promise çš„å¤„ç†å‡½æ•°çš„é“¾è¡¨ï¼Œä¹Ÿå¯ä»¥å­˜
    // Promise çš„æœ€ç»ˆç»“æœï¼Œå› ä¸ºç°åœ¨ Promise å¤„äº pending çŠ¶æ€ï¼Œ
    // æ‰€ä»¥å­˜çš„æ˜¯å¤„ç†å‡½æ•° reaction æ„æˆçš„é“¾è¡¨
    promise.reactions_or_result = reaction;
  } else {
    // fulfilled å’Œ rejected çŠ¶æ€çš„åˆ†æ”¯
    const reactionsOrResult = promise.reactions_or_result;
    let microtask: PromiseReactionJobTask;
    let handlerContext: Context;
    // fulfilled åˆ†æ”¯
    if (promise.Status() == PromiseState::kFulfilled) {
      handlerContext = ExtractHandlerContext(onFulfilled, onRejected);
      // ç”Ÿæˆ microtask ä»»åŠ¡
      microtask = NewPromiseFulfillReactionJobTask(
          handlerContext, reactionsOrResult, onFulfilled,
          resultPromiseOrCapability);
    } else // rejected åˆ†æ”¯
      deferred {
        assert(promise.Status() == PromiseState::kRejected);
        handlerContext = ExtractHandlerContext(onRejected, onFulfilled);
      	// ç”Ÿæˆ microtask ä»»åŠ¡
        microtask = NewPromiseRejectReactionJobTask(
            handlerContext, reactionsOrResult, onRejected,
            resultPromiseOrCapability);
      	// å¦‚æœå½“å‰ promise è¿˜æœªç»‘å®šè¿‡å¤„ç†å‡½æ•°
        if (!promise.HasHandler()) {
          // è§„èŒƒä¸­çš„ HostPromiseRejectionTracker(promise, "reject")ï¼Œ
          // ä½œç”¨æ˜¯äº§ç”Ÿä¸€ä¸ªæ£€æµ‹çš„ microtask ä»»åŠ¡ï¼Œåé¢ä¼šå•ç‹¬ä»‹ç»ã€‚
          runtime::PromiseRevokeReject(promise);
        }
      }
    // å³ä½¿è°ƒç”¨ then æ–¹æ³•æ—¶ promise å·²ç»å¤„äº fulfilled æˆ– rejected çŠ¶æ€ï¼Œ
    // then æ–¹æ³•çš„ onFulfilled æˆ– onRejected å‚æ•°ä¹Ÿä¸ä¼šç«‹åˆ»æ‰§è¡Œï¼Œ
    // è€Œæ˜¯è¿›å…¥ microtask é˜Ÿåˆ—åæ‰§è¡Œ
    EnqueueMicrotask(handlerContext, microtask);
  }
  promise.SetHasHandler();
}
å¤åˆ¶ä»£ç 
```

### PerformPromiseThenImpl å‡½æ•°çš„ pending åˆ†æ”¯

PerformPromiseThenImpl æœ‰ä¸‰ä¸ªåˆ†æ”¯ï¼Œåˆ†åˆ«å¯¹åº” Promise çš„ä¸‰ä¸ªçŠ¶æ€ï¼Œå½“è¢«è°ƒç”¨ then æ–¹æ³•çš„ Promise å¤„äº pending çŠ¶æ€æ—¶åˆ™è¿›å…¥ pending åˆ†æ”¯ã€‚pending åˆ†æ”¯è°ƒç”¨ `NewPromiseReaction` å‡½æ•°ï¼Œåœ¨æ¥æ”¶åˆ°çš„ onFulfilled å’Œ onRejected å‚æ•°çš„åŸºç¡€ä¸Šï¼Œç”Ÿæˆ `PromiseReaction` å¯¹è±¡ï¼Œå­˜å‚¨ Promise çš„å¤„ç†å‡½æ•°ï¼Œå¹¶èµ‹å€¼ç»™ `JSPromise` çš„ `reactions_or_result` å­—æ®µï¼Œç„¶åè°ƒç”¨ `promise.SetHasHandler()` å°† `has_handler` è®¾ç½®ä¸º `true`ï¼ˆè¡¨ç¤ºè¿™ä¸ª Promise å¯¹è±¡å·²ç»ç»‘å®šäº†å¤„ç†å‡½æ•°ï¼‰

è€ƒè™‘ä¸€ä¸ª Promise å¯ä»¥ä¼šè¿ç»­è°ƒç”¨å¤šä¸ª then çš„æƒ…å†µï¼Œæ¯”å¦‚ï¼š

```
const p = new Promise((resolve, reject) => {
  setTimeout(_ => {
    resolve('my code delay 2000 ms') 
  }, 2000)
})

p.then(result => {
  console.log('ç¬¬ 1 ä¸ª then')
})

p.then(result => {
  console.log('ç¬¬ 2 ä¸ª then')
})
å¤åˆ¶ä»£ç 
```

p è°ƒç”¨äº†ä¸¤æ¬¡ then æ–¹æ³•ï¼Œæ¯ä¸ª then æ–¹æ³•éƒ½ä¼šç”Ÿæˆä¸€ä¸ª `PromiseReaction` å¯¹è±¡ã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨ then æ–¹æ³•æ—¶ç”Ÿæˆå¯¹è±¡ PromiseReaction1ï¼Œæ­¤æ—¶ p çš„ `reactions_or_result` å­˜çš„æ˜¯ PromiseReaction1ã€‚

ç¬¬äºŒæ¬¡è°ƒç”¨ then æ–¹æ³•æ—¶ç”Ÿæˆå¯¹è±¡ PromiseReaction2ï¼Œè°ƒç”¨ `NewPromiseReaction` å‡½æ•°æ—¶ï¼Œ`PromiseReaction2.next = PromiseReaction1`ï¼ŒPromiseReaction1 å˜æˆäº† PromiseReaction2 çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæœ€å p çš„ `reactions_or_result` å­˜çš„æ˜¯ PromiseReaction2ã€‚PromiseReaction2 åè¿›å…¥ Promise å¤„ç†å‡½æ•°çš„é“¾è¡¨ï¼Œå´æ˜¯é“¾è¡¨çš„å¤´ç»“ç‚¹ã€‚`NewPromiseReaction` å‡½æ•°[æºç å¦‚ä¸‹](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-misc.tq%2523134 "https://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-misc.tq%23134")ï¼š

```
macro NewPromiseReaction(implicit context: Context)(
    handlerContext: Context, next: Zero|PromiseReaction,
    promiseOrCapability: JSPromise|PromiseCapability|Undefined,
    fulfillHandler: Callable|Undefined,
    rejectHandler: Callable|Undefined): PromiseReaction {
  const nativeContext = LoadNativeContext(handlerContext);
  return new PromiseReaction{
    map: PromiseReactionMapConstant(),
    next: next, // next å­—æ®µå­˜çš„æ˜¯é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
    reject_handler: rejectHandler,// å¤±è´¥å¤„ç†å‡½æ•°
    fulfill_handler: fulfillHandler,// æˆåŠŸå¤„ç†å‡½æ•°
    promise_or_capability: promiseOrCapability,// äº§ç”Ÿçš„æ–°Promiseå¯¹è±¡
    continuation_preserved_embedder_data: nativeContext
        [NativeContextSlot::CONTINUATION_PRESERVED_EMBEDDER_DATA_INDEX]
  };
}
å¤åˆ¶ä»£ç 
```

åœ¨ p å¤„äº pending çŠ¶æ€æ—¶ï¼Œp çš„ reactions_or_result å­—æ®µå¤§è‡´å†…å®¹å¦‚ä¸‹å›¾ã€‚

> **ä¸‹å›¾ä¸æ˜¯ microtask é˜Ÿåˆ—ï¼Œä¸‹å›¾ä¸æ˜¯ microtask é˜Ÿåˆ—ï¼Œä¸‹å›¾ä¸æ˜¯ microtask é˜Ÿåˆ—ã€‚**

![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACbklEQVRoQ+2aMU4dMRCGZw6RC1CSSyQdLZJtKQ2REgoiRIpQkCYClCYpkgIESQFIpIlkW+IIcIC0gUNwiEFGz+hlmbG9b1nesvGW++zxfP7H4/H6IYzkwZFwQAUZmpJVkSeniFJKA8ASIi7MyfkrRPxjrT1JjZ8MLaXUDiJuzwngn2GJaNd7vyP5IoIYY94Q0fEQIKIPRGS8947zSQTRWh8CwLuBgZx479+2BTkHgBdDAgGAC+fcywoyIFWqInWN9BSONbTmFVp/AeA5o+rjKRJ2XwBYRsRXM4ZXgAg2LAPzOCDTJYQx5pSIVlrC3EI45y611osMTHuQUPUiYpiVooerg7TWRwDAlhSM0TuI+BsD0x4kGCuFSRVzSqkfiLiWmY17EALMbCAlMCmI6IwxZo+INgQYEYKBuW5da00PKikjhNNiiPGm01rrbwDwofGehQjjNcv1SZgddALhlJEgwgJFxDNr7acmjFLqCyJuTd6LEGFttpmkYC91Hrk3s1GZFERMmUT01Xv/sQljjPlMRMsxO6WULwnb2D8FEs4j680wScjO5f3vzrlNJszESWq2LYXJgTzjZm56MCHf3zVBxH1r7ftU1splxxKYHEgoUUpTo+grEf303rPH5hxENJqDKQEJtko2q9zGeeycWy3JhpKhWT8+NM/sufIhBwKI+Mta+7pkfxKMtd8Qtdbcx4dUQZcFCQ2I6DcAnLUpf6YMPxhIDDOuxC4C6djoQUE6+tKpewWZ1wlRkq0qUhXptKTlzv93aI3jWmE0Fz2TeujpX73F9TaKy9CeMk8vZusfBnqZ1g5GqyIdJq+XrqNR5AahKr9CCcxGSwAAAABJRU5ErkJggg==)

> å›¾ä¸­ä½¿ç”¨ onFulfilled ä»£æ›¿ fulfill_handler æ˜¯ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼ŒonRejected ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸”åªåŒ…å«äºå½“å‰å†…å®¹ç›¸å…³çš„å­—æ®µï¼Œä¸ç”¨å¤ªè¿‡äºçº ç»“ã€‚

### PerformPromiseThenImpl å‡½æ•°çš„ fulfilled åˆ†æ”¯

fulfilled åˆ†æ”¯é€»è¾‘åˆ™ç®€å•çš„å¤šï¼Œå¤„ç†çš„æ˜¯å½“ Promise å¤„äº fulfilled çŠ¶æ€æ—¶ï¼Œè°ƒç”¨ then æ–¹æ³•çš„é€»è¾‘ï¼š

å…ˆè°ƒç”¨ `NewPromiseFulfillReactionJobTask` ç”Ÿæˆ `microtask`ï¼Œç„¶å `EnqueueMicrotask(handlerContext, microtask)` å°†åˆšæ‰ç”Ÿæˆçš„ `microtask` æ”¾å…¥ `microtask é˜Ÿåˆ—`ï¼Œæœ€åè°ƒç”¨ `promise.SetHasHandler()` å°† `has_handler` è®¾ç½®ä¸º `true`ã€‚

```
new Promise((resolve, reject) => {
  resolve()
}).then(result => {
  console.log('è¿›å…¥ microtask é˜Ÿåˆ—åæ‰§è¡Œ')
})

console.log('åŒæ­¥æ‰§è¡Œç»“æŸ')
// æœ¬æ®µä»£ç çš„æ‰“å°é¡ºåºæ˜¯:
// åŒæ­¥æ‰§è¡Œç»“æŸ
// è¿›å…¥ microtask é˜Ÿåˆ—åæ‰§è¡Œ
å¤åˆ¶ä»£ç 
```

å°½ç®¡è°ƒç”¨ then æ–¹æ³•æ—¶ï¼ŒPromise å·²ç»å¤„äº fulfilled çŠ¶æ€ï¼Œä½† then æ–¹æ³•çš„ onFulfilled å›è°ƒå‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿›å…¥ microtask é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œã€‚

### PerformPromiseThenImpl å‡½æ•°çš„ rejected åˆ†æ”¯

rejected åˆ†æ”¯é€»è¾‘ä¸ fulfilled åˆ†æ”¯çš„é€»è¾‘å¤§è‡´ç›¸åŒï¼Œä½†æ˜¯ rejected åˆ†æ”¯ä¸­å°† onRejected å¤„ç†å‡½æ•°åŠ å…¥ microtask é˜Ÿåˆ—ä¹‹å‰ï¼Œä¼šå…ˆåˆ¤æ–­å½“å‰ promise æ˜¯å¦å·²ç»å­˜åœ¨å¤„ç†å‡½æ•°ï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™ä¼šå…ˆè°ƒç”¨ `runtime::PromiseRevokeReject(promise)`ï¼Œæœ€åè°ƒç”¨ `promise.SetHasHandler()` å°† `has_handler` è®¾ç½®ä¸º `true`ã€‚

```
if (!promise.HasHandler()) {
       runtime::PromiseRevokeReject(promise);
   }
å¤åˆ¶ä»£ç 
```

è¿™é‡Œçš„`runtime::PromiseRevokeReject(promise)` å°±æ˜¯ [ECMAScript è§„èŒƒ](https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-performpromisethen "https://262.ecma-international.org/11.0/#sec-performpromisethen") ä¸­çš„ `HostPromiseRejectionTracker(promise, "handle")`ï¼Œ`HostPromiseRejectionTracker` æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œè¿™è¡¨ç¤ºæ²¡æœ‰è§„å®šå®ƒçš„å…·ä½“çš„é€»è¾‘ã€‚å¤§è‡´çš„ä½œç”¨æ˜¯æ ‡è®°ä¸€ä¸‹ `promise` å·²ç»ç»‘å®šäº† `rejected` çŠ¶æ€çš„å¤„ç†å‡½æ•°ã€‚ä¸ç”¨ç–‘æƒ‘ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œåé¢ä¼šå•ç‹¬é‡ç‚¹è¯´ã€‚

> æ³¨æ„ 1 HostPromiseRejectionTracker åœ¨ä¸¤ç§æƒ…å†µä¸‹è¢«è°ƒç”¨ï¼š
> 
> å½“ä¸€ä¸ª promise åœ¨æ²¡æœ‰ä»»ä½•å¤„ç†ç¨‹åºçš„æƒ…å†µä¸‹è¢«æ‹’ç»æ—¶ï¼Œå®ƒçš„æ“ä½œå‚æ•°è®¾ç½®ä¸º â€œrejectâ€ã€‚
> 
> å½“ç¬¬ä¸€æ¬¡å°†å¤„ç†ç¨‹åºæ·»åŠ åˆ°è¢«æ‹’ç»çš„ Promise ä¸­æ—¶ï¼Œå°†è°ƒç”¨å®ƒå¹¶å°†å…¶æ“ä½œå‚æ•°è®¾ç½®ä¸º â€œhandleâ€ã€‚
> 
> å¼•è‡³ â€”â€”[ECMAScript è§„èŒƒ](https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-host-promise-rejection-tracker "https://262.ecma-international.org/11.0/#sec-host-promise-rejection-tracker") (ä½œè€…ç¿»è¯‘)

### å°ç»“

1.  å½“ä¸€ä¸ª Promise è¢«è°ƒç”¨ then æ–¹æ³•æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Promise å¯¹è±¡ `resultPromise`
    
2.  ç„¶åæ ¹æ®å½“å‰ `promise` çš„ä¸åŒçŠ¶æ€æ‰§è¡Œä¸åŒçš„é€»è¾‘
    
    *   pending çŠ¶æ€ï¼šä¼šå°† `then` ä¼ é€’çš„ä¸¤ä¸ªå¤„ç†å‡½æ•°å˜æˆä¸€ä¸ª `PromiseReaction` èŠ‚ç‚¹æ’å…¥åˆ°`promise.reactions_or_result` å¤´éƒ¨ï¼ˆ`PromiseReaction`æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼‰ï¼Œè¿™ä¸ªæ­¥éª¤å°±æ˜¯åœ¨æœé›†ä¾èµ–ï¼Œç­‰å¾… `promise` çŠ¶æ€å®Œæˆæ—¶å†è§¦å‘ã€‚
    *   fulfilled çŠ¶æ€ï¼šä¼šåˆ›å»ºä¸€ä¸ª microtask æ¥è°ƒç”¨ä¼ å…¥çš„ onFulfilled å¤„ç†å‡½æ•°ï¼Œå¹¶å°† reactions_or_result ä½œä¸ºè°ƒç”¨çš„å‚æ•°ï¼ˆæ­¤æ—¶ `reactions_or_result` æ˜¯ `promise` çš„å€¼ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ `resolve` æ—¶ä¼ å…¥çš„å‚æ•° `value` ï¼‰ï¼Œå¹¶å°†å…¶æ’å…¥ microtask é˜Ÿåˆ—ã€‚
    *   rejected çŠ¶æ€ï¼šä¸ fulfilled çŠ¶æ€ç±»ä¼¼ï¼Œä¼šå°†åˆ›å»ºä¸€ä¸ª microtask æ¥è°ƒç”¨ä¼ å…¥çš„ `onRejected` å¤„ç†å‡½æ•°ï¼Œå¹¶å°† `reactions_or_result` ä½œä¸ºè°ƒç”¨çš„å‚æ•°ï¼Œå¦‚æœå½“å‰ Promise ä¸å­˜åœ¨å¤„ç†å‡½æ•°ï¼ˆä¹Ÿå°±æ˜¯ fulfilled çŠ¶æ€çš„ Promsie é¦–æ¬¡è¢«è°ƒç”¨ then æ–¹æ³•ï¼‰ï¼Œä¼šå°†å…¶æ ‡è®°ä¸ºå·²ç»ç»‘å®š `onRejected` å‡½æ•°ï¼Œç„¶åå°†å…¶ microtask æ’å…¥ microtask é˜Ÿåˆ—ã€‚
3.  è°ƒç”¨ `promise.SetHasHandler()` å°† Promise çš„ `has_handler` è®¾ç½®ä¸º `true`ï¼Œè¡¨ç¤ºå…¶è¢«è°ƒç”¨çš„ then æ–¹æ³•ç»‘å®šäº†å¤„ç†å‡½æ•°ã€‚
    
4.  æœ€åè¿”å›æ–°çš„ Promise å¯¹è±¡ã€‚
    

> å†æ¥å›é¡¾ä¸€ä¸‹ `reactions_or_result` çš„ 3 ä¸ªå€¼çŠ¶æ€ï¼ˆç©ºã€é“¾è¡¨ã€promise çš„å€¼ï¼‰:
> 
> å½“ promise åˆšåˆšè¢«åˆ›å»ºæ—¶ï¼Œreactions_or_result çš„å€¼çš„ç©ºï¼Œ
> 
> å½“ promise çš„çŠ¶æ€æ”¹å˜ä¸º `fulfilled`/`rejected` æ—¶ï¼Œå…¶å€¼æ˜¯è°ƒç”¨å¯¹åº” `resolve(value)`/`reject(value)` å‡½æ•°ä¼ å…¥çš„å‚æ•° `value`ï¼Œä¹Ÿå°±æ˜¯ `promise` çš„å€¼ã€‚
> 
> å½“ promise ä¸º pending çŠ¶æ€ä¸”è¢«è°ƒç”¨ `then` åï¼Œ`reactions_or_result` ä¸ºä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨çš„æ¯ä¸€é¡¹å­˜å‚¨çš„æ˜¯è°ƒç”¨ `then` æ—¶ä¼ å…¥çš„å¤„ç†å‡½æ•°ã€‚

reslove
-------

```
new Promise((resolve, reject) => {
  setTimeout(_ => resolve('fulfilled'), 5000)
}).then(value => {
  console.log(value)
}, reason => {
  console.log('rejected')
})
å¤åˆ¶ä»£ç 
```

ä¸Šè¿°ä»£ç  5s åæ‰§è¡Œ resolve å‡½æ•°ï¼Œæ§åˆ¶å°æ‰“å° fulfilledã€‚

### FulfillPromise

[ECMAScript è§„èŒƒ](https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-fulfillpromise "https://262.ecma-international.org/11.0/#sec-fulfillpromise")

`reslove(value)` å°±æ˜¯è§„èŒƒä¸­çš„ `FulfillPromise(promise, value)` å‡½æ•°ï¼Œä»–çš„ä½œç”¨æ˜¯å°†ä¸€ä¸ª Promise çš„çŠ¶æ€ç”± pending æ”¹å˜ä¸º fulfilledï¼Œå¹¶ä¸”å°†è¿™ä¸ª Promise çš„æ‰€æœ‰å¤„ç†å‡½æ•°éƒ½å˜æˆ microtask åŠ å…¥åˆ° microtask é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œã€‚

resolve å‡½æ•°å½’æ ¹åˆ°åº•è°ƒç”¨äº† V8 çš„ FulfillPromise å‡½æ•°ï¼Œ[æºç å¦‚ä¸‹](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-abstract-operations.tq%2523182 "https://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-abstract-operations.tq%23182")ï¼š

```
// https://tc39.es/ecma262/#sec-fulfillpromise
transitioning builtin
FulfillPromise(implicit context: Context)(
    promise: JSPromise, value: JSAny): Undefined {
  // æ–­æ¡ˆå½“å‰promiseçŠ¶æ€ä¸€å®šæ˜¯ pendingï¼Œå› ä¸ºpromise çš„çŠ¶æ€æ”¹å˜æ˜¯ä¸å¯é€†çš„
  assert(promise.Status() == PromiseState::kPending);

  // å– Promise çš„å¤„ç†å‡½æ•°ï¼Œåœ¨è¿™ä¹‹å‰ Promise çš„çŠ¶æ€è¿˜æ˜¯ pending
  // æ‰€ä»¥ reactions_or_result ä¸­å­˜çš„æ˜¯ reactions é“¾è¡¨ï¼Œ
  // reactions èŠ‚ç‚¹ä¸­å­˜å‚¨çš„æ˜¯é‡Œå‡½æ•°
  const reactions =
      UnsafeCast<(Zero | PromiseReaction)>(promise.reactions_or_result);

  // Promise éœ€è¦ä¿®æ”¹ä¸º fulfilled çŠ¶æ€ï¼Œæ‰€ä»¥ reactions_or_result å­˜å‚¨çš„
  // ä¸å†æ˜¯å¤„ç†å‡½æ•°ï¼Œè€Œæ˜¯ Promise çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ resolve æ—¶ä¼ å…¥çš„å‚æ•°
  promise.reactions_or_result = value;

  // è®¾ç½® Promise çš„çŠ¶æ€ä¸º fulfilled
  promise.SetStatus(PromiseState::kFulfilled);

  // Promise çš„å¤„ç†å‡½æ•°ï¼ŒPromise çš„ç»“æœéƒ½æ‹¿åˆ°äº†ï¼Œå¼€å§‹æ­£å¼å¤„ç†
  TriggerPromiseReactions(reactions, value, kPromiseReactionFulfill);
  return Undefined;
}
å¤åˆ¶ä»£ç 
```

`FulfillPromise` çš„é€»è¾‘æ˜¯è·å– Promise çš„å¤„ç†å‡½æ•°åˆ° `reactions`ï¼Œ`reactions` çš„ç±»å‹æ˜¯ `PromiseReaction`ï¼Œæ˜¯ä¸ªé“¾è¡¨ï¼Œå¿˜è®°çš„åŒå­¦å¯ä»¥å›çœ‹ä¸Šé¢çš„é‚£å¼ é“¾è¡¨å›¾ç‰‡ï¼›è®¾ç½® `promise` çš„ `reactions_or_result` ä¸º `value`ï¼Œè¿™ä¸ª `value` å°±æ˜¯ JavaScript å±‚ä¼ ç»™ `resolve` çš„å‚æ•°ï¼›è°ƒç”¨ `promise.SetStatus(PromiseState::kFulfilled)` è®¾ç½® `promise` çš„çŠ¶æ€ä¸º `fulfilled`ï¼Œæœ€åè°ƒç”¨ `TriggerPromiseReactions` æ¥å°† `reactions` ä¸­çš„å¤„ç†å‡½æ•°æ·»åŠ åˆ° microtask é˜Ÿåˆ—ã€‚

### TriggerPromiseReactions

[æºç å¦‚ä¸‹](https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-abstract-operations.tq%2523140 "https://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-abstract-operations.tq%23140")ï¼š

```
// https://tc39.es/ecma262/#sec-triggerpromisereactions
transitioning macro TriggerPromiseReactions(implicit context: Context)(
    reactions: Zero|PromiseReaction, argument: JSAny,
    reactionType: constexpr PromiseReactionType): void {
  // We need to reverse the {reactions} here, since we record them on the
  // JSPromise in the reverse order.
  let current = reactions;
  let reversed: Zero|PromiseReaction = kZero;
  // é“¾è¡¨åè½¬
  while (true) {
    typeswitch (current) {
      case (Zero): {
        break;
      }
      case (currentReaction: PromiseReaction): {
        current = currentReaction.next;
        currentReaction.next = reversed;
        reversed = currentReaction;
      }
    }
  }
  current = reversed;
  // é“¾è¡¨åè½¬åï¼Œè°ƒç”¨ MorphAndEnqueuePromiseReaction
  // æŠŠé“¾æ¥ä¸­çš„æ¯ä¸€é¡¹éƒ½è¿›å…¥ microtask é˜Ÿåˆ—
  while (true) {
    typeswitch (current) {
      case (Zero): {
        break;
      }
      case (currentReaction: PromiseReaction): {
        current = currentReaction.next;
        MorphAndEnqueuePromiseReaction(currentReaction, argument, reactionType);
      }
    }
  }
}
å¤åˆ¶ä»£ç 
```

`TriggerPromiseReactions` åšäº†ä¸¤ä»¶äº‹ï¼š

*   åè½¬ `reactions` é“¾è¡¨ï¼Œå‰æ–‡æœ‰åˆ†æè¿‡ then æ–¹æ³•çš„å®ç°ï¼Œthen æ–¹æ³•çš„å‚æ•°æœ€ç»ˆå­˜åœ¨é“¾è¡¨ä¸­ã€‚æœ€åè¢«è°ƒç”¨çš„ then æ–¹æ³•ï¼Œå®ƒæ¥æ”¶çš„å‚æ•°è¢«åŒ…è£…åä¼šä½äºé“¾è¡¨çš„å¤´éƒ¨ï¼Œè¿™ä¸ç¬¦åˆè§„èŒƒï¼Œæ‰€ä»¥éœ€è¦åè½¬
*   éå† `reactions` å¯¹è±¡ï¼Œè°ƒç”¨ MorphAndEnqueuePromiseReaction å°†æ¯ä¸ªå…ƒç´ æ”¾å…¥ microtask é˜Ÿåˆ—

### MorphAndEnqueuePromiseReaction

[MorphAndEnqueuePromiseReaction](https://link.juejin.cn?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-abstract-operations.tq%252384 "http://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-abstract-operations.tq%2384") å°† PromiseReaction è½¬ä¸º microtaskï¼Œæœ€ç»ˆæ’å…¥ microtask é˜Ÿåˆ—ï¼Œmorph æœ¬èº«æœ‰è½¬å˜ / è½¬åŒ–çš„æ„æ€ï¼Œæ¯”å¦‚ Polymorphism (å¤šæ€)ã€‚

MorphAndEnqueuePromiseReaction æ¥æ”¶ 3 ä¸ªå‚æ•°ï¼ŒPromiseReaction æ˜¯å‰é¢æåˆ°çš„åŒ…è£…äº† Promise å¤„ç†å‡½æ•°çš„é“¾è¡¨å¯¹è±¡ï¼Œargument æ˜¯ resolve/reject çš„å‚æ•°ï¼ŒreactionType è¡¨ç¤º Promise æœ€ç»ˆçš„çŠ¶æ€ï¼Œfulfilled çŠ¶æ€å¯¹åº”çš„å€¼æ˜¯ kPromiseReactionFulfillï¼Œrejected çŠ¶æ€å¯¹åº”çš„å€¼æ˜¯ kPromiseReactionRejectã€‚

MorphAndEnqueuePromiseReaction çš„é€»è¾‘å¾ˆç®€å•ï¼Œå› ä¸ºæ­¤æ—¶å·²ç»çŸ¥é“äº† Promise çš„æœ€ç»ˆçŠ¶æ€ï¼Œæ‰€ä»¥å¯ä»¥ä» promiseReaction å¯¹è±¡å¾—åˆ° promiseReactionJobTask å¯¹è±¡ï¼ŒpromiseReactionJobTask çš„å˜é‡å‘½åä¸ ECMAScript è§„èŒƒç›¸å…³æè¿°ä¸€è„‰ç›¸æ‰¿ï¼Œå…¶å®å°±æ˜¯ä¼ è¯´ä¸­çš„ microtaskã€‚MorphAndEnqueuePromiseReaction æºç å¦‚ä¸‹ï¼Œä»…ä¿ç•™äº†å’Œæœ¬å°èŠ‚ç›¸å…³çš„å†…å®¹ã€‚

```
transitioning macro MorphAndEnqueuePromiseReaction(implicit context: Context)(
    promiseReaction: PromiseReaction, argument: JSAny,
    reactionType: constexpr PromiseReactionType): void {
  let primaryHandler: Callable|Undefined;
  let secondaryHandler: Callable|Undefined;
  // æ ¹æ®ä¸åŒçš„ Promise çŠ¶æ€é€‰å–ä¸åŒçš„å›è°ƒæ‰§è¡Œ
  if constexpr (reactionType == kPromiseReactionFulfill) {
    primaryHandler = promiseReaction.fulfill_handler;
    secondaryHandler = promiseReaction.reject_handler;
  } else {
    primaryHandler = promiseReaction.reject_handler;
    secondaryHandler = promiseReaction.fulfill_handler;
  }
  const handlerContext: Context =
      ExtractHandlerContext(primaryHandler, secondaryHandler);
  if constexpr (reactionType == kPromiseReactionFulfill) {// fulfilled åˆ†æ”¯
    * UnsafeConstCast(& promiseReaction.map) =
        PromiseFulfillReactionJobTaskMapConstant();
    const promiseReactionJobTask =
        UnsafeCast<PromiseFulfillReactionJobTask>(promiseReaction);
    // argument æ˜¯ reject çš„å‚æ•°
    promiseReactionJobTask.argument = argument;
    // handler æ˜¯ JS å±‚é¢ then æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œæˆ– catch æ–¹æ³•çš„å‚æ•°
    promiseReactionJobTask.context = handlerContext;
    // promiseReactionJobTask å°±æ˜¯é‚£ä¸ªå·¥ä½œä¸­ç»å¸¸è¢«åå¤æèµ·çš„ microtask
    // EnqueueMicrotask å°† microtask æ’å…¥ microtask é˜Ÿåˆ—
    EnqueueMicrotask(handlerContext, promiseReactionJobTask);
    // åˆ é™¤
  } else {// rejected åˆ†æ”¯
      // é€»è¾‘ä¸ fulfilled åˆ†æ”¯å‰é¢ä¸€è‡´
    * UnsafeConstCast(& promiseReaction.map) =
        PromiseRejectReactionJobTaskMapConstant();
    const promiseReactionJobTask =
        UnsafeCast<PromiseRejectReactionJobTask>(promiseReaction);
    promiseReactionJobTask.argument = argument;
    promiseReactionJobTask.context = handlerContext;
    promiseReactionJobTask.handler = primaryHandler;
    EnqueueMicrotask(handlerContext, promiseReactionJobTask);
  }
}
å¤åˆ¶ä»£ç 
```

MorphAndEnqueuePromiseReaction çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯æ ¹æ® Promise çš„çŠ¶æ€é€‰å– onFulfilled è¿˜æ˜¯ onRejected æ”¾åˆ° microtask é˜Ÿåˆ—å‡†å¤‡æ‰§è¡Œã€‚è¿™é‡Œèµ°çš„æ˜¯ fulfilled åˆ†æ”¯ï¼Œæ‰€ä»¥é€‰å–çš„æ˜¯ onFulfilledã€‚

```
const myPromise4 = new Promise((resolve, reject) => {
  setTimeout(_ => {
    resolve('my code delay 1000') 
  }, 1000)
})

myPromise4.then(result => {
  console.log('ç¬¬ 1 ä¸ª then')
})

myPromise4.then(result => {
  console.log('ç¬¬ 2 ä¸ª then')
})
// æ‰“å°é¡ºåºï¼š
// ç¬¬ 1 ä¸ª then
// ç¬¬ 2 ä¸ª then
// å¦‚æœæŠŠ TriggerPromiseReactions ä¸­é“¾è¡¨åè½¬çš„ä»£ç æ³¨é‡Šæ‰ï¼Œæ‰“å°é¡ºåºä¸º
// ç¬¬ 2 ä¸ª then
// ç¬¬ 1 ä¸ª then
å¤åˆ¶ä»£ç 
```

### å°ç»“

resolve åªä¼šå¤„ç†çŠ¶æ€ä¸º pending çš„ Promiseï¼Œä¼šå°† Promise çš„ `reactions_or_result` è®¾ç½®ä¸ºä¼ å…¥çš„ `value`ï¼Œç”¨æ¥ä½œä¸º Promise çš„å€¼ï¼Œå¹¶ä¸”ä¼šå°† Promise çš„çŠ¶æ€ä¿®æ”¹ä¸º fulfilledã€‚

åœ¨è°ƒç”¨ resolve ä¹‹å‰ `reactions_or_result` å…¶å®æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå­˜å‚¨çš„æ˜¯å½“å‰ Promise çš„æ‰€æœ‰å¤„ç†å‡½æ•°ï¼Œå› ä¸º promise åœ¨ä½¿ç”¨ then æ”¶é›†ä¾èµ–æ—¶æ˜¯å°†æœ€æ–°çš„ä¾èµ–å­˜æ”¾åˆ°é“¾è¡¨å¤´éƒ¨ï¼Œæ‰€ä»¥è¿˜éœ€è¦å…ˆå¯¹é“¾è¡¨è¿›è¡Œåè½¬ï¼Œç„¶åå°†å…¶æŒ¨ä¸ªæ”¾å…¥ microtask é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ

> resolve çš„ä¸»è¦å·¥ä½œæ˜¯éå†ä¸ŠèŠ‚è°ƒç”¨ then æ–¹æ³•æ—¶æ”¶é›†åˆ°çš„ä¾èµ–ï¼Œæ”¾å…¥ microtask é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œã€‚

reject
------

reject ä¸ reslove æ²¡ä»€ä¹ˆå¤ªå¤§å·®åˆ«

[ECMAScript è§„èŒƒ](https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-rejectpromise "https://262.ecma-international.org/11.0/#sec-rejectpromise")

```
new Promise((resolve, reject) => {
  setTimeout(_ => reject('rejected'), 5000)
}).then(_ => {
  console.log('fulfilled')
}, reason => {
  console.log(reason)
})
å¤åˆ¶ä»£ç 
```

ä¸Šè¿°ä»£ç  5s åæ‰§è¡Œ reject å‡½æ•°ï¼Œæ§åˆ¶å°æ‰“å° rejectedã€‚

### RejectPromise

[ECMAScript è§„èŒƒ](https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-rejectpromise "https://262.ecma-international.org/11.0/#sec-rejectpromise")

`reject(season)` å‡½æ•°è°ƒç”¨äº† V8 çš„ `RejectPromise(promise, season)` å‡½æ•°ï¼Œ[æºç å¦‚ä¸‹](https://link.juejin.cn?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-abstract-operations.tq%2523210 "http://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-abstract-operations.tq%23210") ï¼š

```
// https://tc39.es/ecma262/#sec-rejectpromise
transitioning builtin
RejectPromise(implicit context: Context)(
    promise: JSPromise, reason: JSAny, debugEvent: Boolean): JSAny {
	
  // å¦‚æœå½“å‰ Promise æ²¡æœ‰ç»‘å®šå¤„ç†å‡½æ•°ï¼Œ
  // åˆ™ä¼šè°ƒç”¨ runtime::RejectPromise
  if (IsPromiseHookEnabledOrDebugIsActiveOrHasAsyncEventDelegate() ||
      !promise.HasHandler()) {
    return runtime::RejectPromise(promise, reason, debugEvent);
  }
 
  // å–å‡º Promise çš„å¤„ç†å¯¹è±¡ PromiseReaction
  const reactions =
      UnsafeCast<(Zero | PromiseReaction)>(promise.reactions_or_result);
  // è¿™é‡Œçš„ reason å°±æ˜¯ reject å‡½æ•°çš„å‚æ•°
  promise.reactions_or_result = reason;
  // è®¾ç½® Promise çš„çŠ¶æ€ä¸º rejected
  promise.SetStatus(PromiseState::kRejected);
  // å°† Promise çš„å¤„ç†å‡½æ•°éƒ½æ·»åŠ åˆ° microtask é˜Ÿåˆ—
  TriggerPromiseReactions(reactions, reason, kPromiseReactionReject);
  return Undefined;
}
å¤åˆ¶ä»£ç 
```

### HostPromiseRejectionTracker

ä¸ ReslovePromise ç›¸æ¯”ï¼ŒRejectPromise ä¸­å¤šå‡ºä¸€ä¸ªåˆ¤æ–­ Promsie æ˜¯å¦ç»‘å®šäº†å¤„ç†å‡½æ•°çš„åˆ¤æ–­ï¼Œå¦‚æœæ²¡æœ‰ç»‘å®šå¤„ç†å‡½æ•°åˆ™ä¼šå…ˆæ‰§è¡Œ `runtime::RejectPromise(promise, reason, debugEvent)`ï¼Œè¿™æ˜¯å…¶å®æ˜¯ ECMAScript è§„èŒƒä¸­çš„ `HostPromiseRejectionTracker(promise, "reject")` ï¼Œè¿™å·²ç»æ˜¯ç¬¬äºŒæ¬¡æåˆ° `HostPromiseRejectionTracker`äº†ã€‚

> åœ¨ **PerformPromiseThenImpl å‡½æ•°çš„ rejected åˆ†æ”¯** å¤„æœ‰æåˆ°è¿‡ä¸€æ¬¡ã€‚

åœ¨ ECMAScript è§„èŒƒä¸­ HostPromiseRejectionTracker æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œä»–ç”šè‡³æ²¡æœ‰æ˜ç¡®çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¥½åœ¨è§„èŒƒä¸­æè¿°äº†ä»–çš„ä½œç”¨ã€‚

HostPromiseRejectionTracker ç”¨äºè·Ÿè¸ª Promise çš„ rejectedï¼Œä¾‹å¦‚å…¨å±€çš„ `rejectionHandled` äº‹ä»¶å°±æ˜¯ç”±å®ƒå®ç°ã€‚

> æ³¨ 1 HostPromiseRejectionTracker åœ¨ä¸¤ç§æƒ…å†µä¸‹è¢«è°ƒç”¨ï¼š
> 
> å½“ä¸€ä¸ª Promise åœ¨æ²¡æœ‰ä»»ä½•å¤„ç†å‡½æ•°çš„æƒ…å†µä¸‹è¢«è°ƒç”¨ reject æ—¶ï¼Œè°ƒç”¨å®ƒå¹¶ä¸”ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ â€œrejectâ€ã€‚
> 
> å½“ç¬¬ä¸€æ¬¡ä¸º rejected çŠ¶æ€çš„ Promise ç»‘å®šå¤„ç†å‡½æ•°æ—¶ï¼Œè°ƒç”¨å®ƒå¹¶ä¸”ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ â€œhandleâ€ã€‚

æ‰€ä»¥åœ¨è¿™é‡Œï¼Œå½“ä¼ é€’ `â€œhandleâ€` å°±ç›¸å¯¹äºä¸ºè¿™ä¸ª Promise å¯¹è±¡æ ‡è®°ä¸ºå·²ç»ç»‘å®šäº†å¤„ç†å‡½æ•°ï¼Œå½“ä¼ é€’ `â€œrejectâ€` ç›¸å¯¹äºæ ‡è®°è¿™ä¸ª Promise å¯¹è±¡è¿˜æ²¡æœ‰å¤„ç†å‡½æ•°ã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹å‡ æ®µä»£ç çœ‹çœ‹ä»–çš„å®é™…ä½œç”¨

å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ª Promise çš„çŠ¶æ€ä¸º reject ä¸”æœªä¸ºå…¶ç»‘å®š onRejected çš„å¤„ç†å‡½æ•°æ—¶ï¼Œ JavaScript ä¼šæŠ›å‡ºé”™è¯¯

```
const myPromise1 = new Promise((resolve, reject) => {
    reject()
})
// æŠ¥é”™
å¤åˆ¶ä»£ç 
```

å¹¶ä¸”æ£€æµ‹æ˜¯å¦ç»‘å®šå¤„ç†å‡½æ•°æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹

```
console.log(1);
const myPromise1 = new Promise((resolve, reject) => {
    reject()
})
console.log(2);
// 1
// 2
// æŠ¥é”™
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬å¯ä»¥ä¸ºå…¶ç»‘å®šä¸€ä¸ª onRejected å¤„ç†å‡½æ•°æ¥è§£å†³æˆ‘ä»¬æŠ¥é”™

```
const myPromise1 = new Promise((resolve, reject) => {
    reject()
})// å¾—åˆ°ä¸€ä¸ª rejected çŠ¶æ€çš„ Promise
myPromise1.then(undefined, console.log)
å¤åˆ¶ä»£ç 
```

ä½ ä¸€å®šä¼šç–‘æƒ‘ï¼ŒPromise æ˜¯åœ¨ä½•æ—¶æ£€æµ‹å®ƒæ˜¯å¦ç»‘å®šäº† onRejected å¤„ç†å‡½æ•°ï¼Œå¦‚ä½•æ£€æµ‹çš„ï¼Ÿ

è¿™å°±æ˜¯ HostPromiseRejectionTracker çš„ä½œç”¨ï¼Œåœ¨ ECMAScript è§„èŒƒä¸­è¿˜æåˆ°ï¼Œå½“è°ƒç”¨ `HostPromiseRejectionTracker(promise, 'reject')` æ—¶ï¼Œ å¦‚æœ promsie ä¸å­˜åœ¨å¤„ç†å‡½æ•°ï¼Œåˆ™ä¼šä¸ºå…¶è®¾ç½®ä¸€ä¸ªå¤„ç†å‡½æ•°ã€‚

å›åˆ°ä¸Šé¢çš„é€»è¾‘ï¼Œå½“ä¸€ä¸ª Promise çš„ reject å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œ å¦‚æœæ²¡æœ‰ onRejected å¤„ç†å‡½æ•°ï¼Œåˆ™ä¼šè°ƒç”¨ `runtime::RejectPromise` æ¥ä¸ºå…¶æ·»åŠ ä¸€ä¸ªå¤„ç†å‡½æ•°ï¼Œç„¶ååé¢ä¼šè°ƒç”¨ `TriggerPromiseReactions` å°†è¿™ä¸ªå¤„ç†å‡½æ•°åŠ å…¥åˆ° microtask é˜Ÿåˆ—ï¼Œè¿™ä¸ªå¤„ç†å‡½æ•°æ‰§è¡Œæ—¶åšçš„äº‹æƒ…å°±æ˜¯å†æ¬¡æ£€æµ‹ Promise æ˜¯å¦è¢«ç»‘å®šäº†æ–°çš„ onRejectedï¼ˆä¹Ÿå°±æ˜¯æœ‰æ²¡æœ‰åœ¨æ­¤æœŸé—´æ‰§è¡Œäº† `HostPromiseRejectionTracker(promise, 'handle')` ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœæœ‰åˆ™ä»€ä¹ˆä¹Ÿä¸å‘ç”Ÿã€‚

```
// ä¸å¯è¿è¡Œçš„jsä¼ªä»£ç 
function HostPromiseRejectionTracker(promise, status) {
  if (status === 'handle') {
    promise.HasHandler = true
  } else if (status === 'reject'){
    promise.catch(() => {
      if (!promise.HasHandler) {
        throw new Error('Uncaught (in promise) ' + promise.value)
      }
    })
  }
}

RejectPromise(){
  //...
  if (!promise.HasHandler) {
    HostPromiseRejectionTracker(promise, 'reject')
  }
  //...
}

FulfillPromise(){
  //...
  if (!promise.HasHandler) {
    HostPromiseRejectionTracker(promise, 'handle')
  }
  //...
}
å¤åˆ¶ä»£ç 
```

æ‰€ä»¥åœ¨å¯¹ä¸€ä¸ª reject çŠ¶æ€çš„ Promise è°ƒç”¨ then æ–¹æ³•æ—¶éœ€è¦å¯¹å…¶è°ƒç”¨ `runtime::PromiseRevokeReject(promise)` æ¥è¡¨ç¤ºè¿™ä¸ª Promise ç»‘å®šäº†æ–°çš„ onRejectedï¼Œé˜²æ­¢é”™è¯¯è¢«æŠ›å‡ºã€‚

æ‰€ä»¥ä½ å¿…é¡»è¦èµ¶åœ¨è¿™ä¸ªæ£€æµ‹çš„ microtask æ‰§è¡Œä¹‹å‰ç»‘å®šå¤„ç†å‡½æ•°æ‰èƒ½é˜²æ­¢è¿™ä¸ªé”™è¯¯çš„æŠ›å‡ºã€‚

```
const myPromise1 = new Promise((resolve, reject) => {
    // åŒæ­¥æ‰§è¡Œ
    reject()
    // ä¼šå‘ microtask é˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªæ£€æŸ¥ myPromise1 
    // æ˜¯å¦ç»‘å®šäº†æ–°çš„ onRejected å¤„ç†å‡½æ•°çš„ microtask
})

// macrotask
setTimeout(() => {
  	// æ­¤æ—¶ microtask å·²ç»æ‰§è¡Œï¼Œé”™è¯¯å·²ç»æŠ›å‡ºï¼Œæ¥ä¸åŠäº†
    myPromise1.then(undefined, console.log)
}, 0)
å¤åˆ¶ä»£ç 
```

> **æ³¨æ„ï¼š** Â æµè§ˆå™¨æ§åˆ¶å°æœ‰ä¸€ä¸ªéå¸¸å¥‡æ€ªçš„ç‰¹æ€§ï¼Œå¦‚æœåœ¨è¿™ä¸ªé”™è¯¯è¾“å‡ºååœ¨ä¸ºå…¶ç»‘å®š onrejected å¤„ç†å‡½æ•°ï¼Œæµè§ˆå™¨ä¼šå°†æ§åˆ¶å°çš„é”™è¯¯è¦†ç›–æ‰ã€‚æ‰€ä»¥å¦‚æœä½ åœ¨æµè§ˆå™¨æ‰§è¡Œè¿™æ®µä»£ç ï¼Œ**è¯·å°† setTimeout çš„æ—¶é—´è®¾ç½®é•¿ä¸€ç‚¹**ï¼Œè¿™æ ·æ•ˆæœæ›´åŠ å®¹æ˜“è‚‰çœ¼å¯è§ï¼Œæˆ–è€…åˆ‡æ¢åˆ° node ç¯å¢ƒä¸­æ¥è¿è¡Œã€‚

### å°ç»“

reject å’Œ resolve çš„é€»è¾‘åŸºæœ¬ç›¸åŒï¼Œåˆ†ä¸º 4 æ­¥ï¼š

*   è®¾ç½® Promise çš„ reasonï¼Œä¹Ÿå°±æ˜¯ reject çš„å‚æ•°
*   è®¾ç½® Promise çš„çŠ¶æ€ï¼šrejected
*   å¦‚æœ Promise æ²¡æœ‰ onRejected å¤„ç†å‡½æ•°ï¼Œåˆ™ä¼šä¸ºå…¶æ·»åŠ ä¸€ä¸ªå†æ¬¡æ£€æµ‹ Promise æ˜¯å¦ç»‘å®š onRejected çš„å¤„ç†å‡½æ•°ï¼Œè¿™ä¸ªå¤„ç†å‡½æ•°ä¼šè¢«æ”¾å…¥ microtask é˜Ÿåˆ—ï¼Œå¦‚æœå…¶æ‰§è¡Œæ—¶ Promise è¿˜æœªç»‘å®š onRejectedï¼Œåˆ™ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚
*   ç”±ä¹‹å‰è°ƒç”¨ then/catch æ–¹æ³•æ—¶æ”¶é›†åˆ°çš„ä¾èµ–å­˜å‚¨åˆ° `reactions_or_result` çš„å¤„ç†å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è®¸å¤š promiseReaction èŠ‚ç‚¹å¯¹è±¡ï¼Œå¾—åˆ°ä¸€ä¸ªä¸ª microtaskï¼Œæœ€åå°†è¿™äº› microtask æ’å…¥ microtask é˜Ÿåˆ—

catch
-----

```
new Promise((resolve, reject) => {
    setTimeout(reject, 2000)
}).catch(_ => {
    console.log('rejected')
})
å¤åˆ¶ä»£ç 
```

### PromisePrototypeCatch

ä»¥ä¸Šé¢ä»£ç ä¸ºä¾‹ï¼Œå½“ catch æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œè°ƒç”¨äº† V8 çš„ [PromisePrototypeCatch](https://link.juejin.cn?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-constructor.tq%2523100 "http://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-constructor.tq%23100") æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š

```
transitioning javascript builtin
PromisePrototypeCatch(
    js-implicit context: Context, receiver: JSAny)(onRejected: JSAny): JSAny {
  const nativeContext = LoadNativeContext(context);
  return UnsafeCast<JSAny>(
      InvokeThen(nativeContext, receiver, Undefined, onRejected));
}
å¤åˆ¶ä»£ç 
```

PromisePrototypeCatch çš„æºç ç¡®å®åªæœ‰å°±è¿™å‡ è¡Œï¼Œé™¤äº†è°ƒç”¨ InvokeThen æ–¹æ³•å†æ— å…¶å®ƒ ã€‚

### InvokeThen

ä»åå­—å¯ä»¥æ¨æµ‹å‡ºï¼ŒInvokeThen è°ƒç”¨çš„æ˜¯ Promise çš„ then æ–¹æ³•ï¼Œ[InvokeThen](https://link.juejin.cn?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-misc.tq%2523199 "http://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-misc.tq%23199") æºç å¦‚ä¸‹ï¼š

```
transitioning
macro InvokeThen<F: type>(implicit context: Context)(
    nativeContext: NativeContext, receiver: JSAny, arg1: JSAny, arg2: JSAny,
    callFunctor: F): JSAny {
  if (!Is<Smi>(receiver) &&
      IsPromiseThenLookupChainIntact(
          nativeContext, UnsafeCast<HeapObject>(receiver).map)) {
    const then =
        UnsafeCast<JSAny>(nativeContext[NativeContextSlot::PROMISE_THEN_INDEX]);
    // é‡ç‚¹åœ¨ä¸‹é¢ä¸€è¡Œï¼Œè°ƒç”¨ then æ–¹æ³•å¹¶è¿”å›ï¼Œä¸¤ä¸ªåˆ†æ”¯éƒ½ä¸€æ ·
    return callFunctor.Call(nativeContext, then, receiver, arg1, arg2);
  } else
    deferred {
      const then = UnsafeCast<JSAny>(GetProperty(receiver, kThenString));
      // é‡ç‚¹åœ¨ä¸‹é¢ä¸€è¡Œï¼Œè°ƒç”¨ then æ–¹æ³•å¹¶è¿”å›ï¼Œä¸¤ä¸ªåˆ†æ”¯éƒ½ä¸€æ ·
      return callFunctor.Call(nativeContext, then, receiver, arg1, arg2);
    }
}
å¤åˆ¶ä»£ç 
```

InvokeThen æ–¹æ³•æœ‰ if/else ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸¤ä¸ªåˆ†æ”¯çš„é€»è¾‘å·®ä¸å¤šï¼Œæœ¬å°èŠ‚çš„ JS ç¤ºä¾‹ä»£ç èµ°çš„æ˜¯ if åˆ†æ”¯ã€‚å…ˆæ˜¯æ‹¿åˆ° V8 åŸç”Ÿçš„ then æ–¹æ³•ï¼Œç„¶åé€šè¿‡ `callFunctor.Call(nativeContext, then, receiver, arg1, arg2)` è°ƒç”¨ then æ–¹æ³•ã€‚then æ–¹æ³•ä¹‹å‰æœ‰ä»‹ç»ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚

æ—¢ç„¶ catch æ–¹æ³•åº•å±‚è°ƒç”¨äº† then æ–¹æ³•ï¼Œé‚£ä¹ˆ catch æ–¹æ³•ä¹Ÿæœ‰å’Œ then æ–¹æ³•ä¸€æ ·çš„è¿”å›å€¼ï¼Œcatch æ–¹æ³•å¯ä»¥ç»§ç»­æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥ç»§ç»­é“¾å¼è°ƒç”¨ã€‚

```
new Promise((resolve, reject) => {
    setTimeout(reject, 2000)
}).catch(_ => {
    throw 'rejected'
}).catch(_ => {
    console.log('last catch')
})
å¤åˆ¶ä»£ç 
```

ä¸Šé¢çš„ä»£ç ç¬¬ 2 ä¸ª catch æ•è·ç¬¬ 1 ä¸ª catch æŠ›å‡ºçš„å¼‚å¸¸ï¼Œæœ€åæ‰“å° last catchã€‚

### å°ç»“

catch æ–¹æ³•é€šè¿‡åº•å±‚è°ƒç”¨ then æ–¹æ³•æ¥å®ç° å‡å¦‚ obj æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼ŒJS å±‚é¢ obj.catch(onRejected) ç­‰ä»·äº obj.then(undefined, onRejected)

then çš„é“¾å¼è°ƒç”¨ä¸ microtask é˜Ÿåˆ—ï¼ˆé‡è¦ï¼‰
----------------------------

```
Promise.resolve('123')
    .then(() => {throw new Error('456')})
    .then(_ => {
        console.log('shouldnot be here')
    })
    .catch((e) => console.log(e))
    .then((data) => console.log(data));
å¤åˆ¶ä»£ç 
```

ä»¥ä¸Šä»£ç è¿è¡Œåï¼Œæ‰“å° Error: 456 å’Œ undefinedã€‚ä¸ºäº†ä¾¿äºå™è¿°ï¼Œå°† then çš„é“¾å¼è°ƒç”¨å†™æ³•æ”¹ä¸ºå•°å—¦å†™æ³•ã€‚

```
const p0 = Promise.resolve('123')
const p1 = p0.then(() => {throw new Error('456')})
const p2 = p1.then(_ => {
    console.log('shouldnot be here')
})
const p3 = p2.catch((e) => console.log(e))
const p4 = p3.then((data) => console.log(data));
å¤åˆ¶ä»£ç 
```

then æ–¹æ³•è¿”å›æ–°çš„ Promiseï¼Œæ‰€ä»¥ p0ã€p1ã€p2ã€p3 å’Œ p4 è¿™ 5 ä¸ª Promise äº’ä¸ç›¸ç­‰ã€‚

> å½“ä¸€ä¸ª Promise å¤„äº rejected çŠ¶æ€æ—¶ï¼Œå¦‚æœæ‰¾ä¸åˆ° onRejected å¤„ç†å‡½æ•°åˆ™ä¼šå°† rejected çš„çŠ¶æ€å’Œå…¶å€¼å¾€ä¸‹ä¼ é€’ï¼Œç›´åˆ°æ‰¾åˆ°ä¸ºæ­¢ã€‚ï¼ˆresolve ä¹Ÿæ˜¯ä¸€æ ·ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹åé¢ä¼šä»‹ç»
> 
> catch æ–¹æ³•çš„ä½œç”¨å°±æ˜¯ç»‘å®š onRejected å‡½æ•°

### microtask çš„æ‰§è¡Œ

æ‰€æœ‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ‰§è¡Œå– microtask é˜Ÿåˆ—ä¸­çš„ microtask æ‰§è¡Œï¼Œæ ¸å¿ƒæ–¹æ³•æ˜¯ [MicrotaskQueueBuiltinsAssembler::RunSingleMicrotask](https://link.juejin.cn?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fbuiltins-microtask-queue-gen.cc%2523114 "http://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/builtins-microtask-queue-gen.cc%23114") ï¼Œç”±äº microtask çš„ç±»å‹ç”±å¾ˆå¤šç§ï¼Œæ‰€ä»¥ RunSingleMicrotask çš„åˆ†æ”¯æœ‰è®¸å¤šã€‚è¿™é‡Œå°±ä¸åˆ—å‡ºä»£ç äº†ã€‚

### PromiseReactionJob

åœ¨æ‰§è¡Œ microtask çš„è¿‡ç¨‹ä¸­ï¼ŒMicrotaskQueueBuiltinsAssembler::RunSingleMicrotask ä¼šè°ƒç”¨ [PromiseReactionJob](https://link.juejin.cn?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%252B%2Frefs%2Fheads%2F8.4-lkgr%2Fsrc%2Fbuiltins%2Fpromise-reaction-job.tq%252343 "http://link.zhihu.com/?target=https%3A//chromium.googlesource.com/v8/v8.git/%2B/refs/heads/8.4-lkgr/src/builtins/promise-reaction-job.tq%2343")ï¼Œæºç å¦‚ä¸‹ï¼š

```
transitioning
macro PromiseReactionJob(
    context: Context, argument: JSAny, handler: Callable|Undefined,
    promiseOrCapability: JSPromise|PromiseCapability|Undefined,
    reactionType: constexpr PromiseReactionType): JSAny {
  if (handler == Undefined) {
    // æ²¡æœ‰å¤„ç†å‡½æ•°çš„ caseï¼Œé€ä¼ ä¸Šä¸€ä¸ª Promise çš„ argument
    if constexpr (reactionType == kPromiseReactionFulfill) {
      // åŸºæœ¬ç±»åŒ JS å±‚çš„ resolve
      return FuflfillPromiseReactionJob(
          context, promiseOrCapability, argument, reactionType);
    } else {
      // åŸºæœ¬ç±»åŒ JS å±‚çš„ reject
      return RejectPromiseReactionJob(
          context, promiseOrCapability, argument, reactionType);
    }
  } else {
    try {
      // è¯•å›¾è°ƒç”¨ Promise å¤„ç†å‡½æ•°ï¼Œç›¸å½“äº handler(argument)
      const result =
          Call(context, UnsafeCast<Callable>(handler), Undefined, argument);
        // åŸºæœ¬ç±»åŒ JS å±‚çš„ resolve
        return FuflfillPromiseReactionJob(
            context, promiseOrCapability, result, reactionType);
    } catch (e) {
      // åŸºæœ¬ç±»åŒ JS å±‚çš„ rejectï¼Œå½“æ‰§è¡Œ handler æ˜¯æŠ›å‡ºå¼‚å¸¸ä¼šè§¦å‘
      return RejectPromiseReactionJob(
          context, promiseOrCapability, e, reactionType);
    }
  }
}
å¤åˆ¶ä»£ç 
```

PromiseReactionJob ä¸­ä¼šåˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯å¦å­˜åœ¨éœ€è¦æ‰§è¡Œçš„å¤„ç†å‡½æ•°ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ç›´æ¥å°†ä¸Šä¸€ä¸ª Promise çš„å€¼ä½œä¸ºå‚æ•°è°ƒç”¨ FuflfillPromiseReactionJob ï¼Œå¦‚æœå­˜åœ¨åˆ™æ‰§è¡Œè¿™ä¸ªå¤„ç†å‡½æ•°ï¼Œå°†æ‰§è¡Œç»“æœå½“åšå‚æ•°è°ƒç”¨ FuflfillPromiseReactionJobã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦ä¸€ä¸ª Promise çš„ onFulfilled æˆ–è€… onRejected åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åªè¦æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸ª Promise å°±ä¼šæ‰§è¡Œ FuflfillPromiseReactionJob å°†çŠ¶æ€ä¿®æ”¹ä¸º fulfilledã€‚å¦‚æœæŠ›å‡ºå¼‚å¸¸åˆ™æ‰§è¡Œ RejectPromiseReactionJobã€‚

```
let p0 = new Promise((resolve, reject) => {
    reject(123)
})
// p1 çš„çŠ¶æ€ä¸º reject

let p1 = p0.then(value => {
    console.log(value);
}, reason => {
    console.log(reason);
  	return 2
})
// å°† reason => {console.log(reason)} åŠ å…¥ microtask é˜Ÿåˆ—

p1.then(_ => {
    console.log('p1');
})
// ä¸º p1 æ·»åŠ  PromiseReaction

// å–  microtask é˜Ÿåˆ— ç¬¬ä¸€ä¸ªæ‰§è¡Œï¼Œ
// handler ä¸º reason => {console.log(reason)}ï¼Œ

// æˆåŠŸæ‰§è¡Œ handler, æ‰€ä»¥è°ƒç”¨ FuflfillPromiseReactionJob 
// æ‰§è¡Œ p1 çš„ resolve
å¤åˆ¶ä»£ç 
```

> æ³¨æ„ï¼šFuflfillPromiseReactionJob åšçš„äº‹æƒ…å¾ˆå¤šï¼Œæ‰§è¡Œ resolve åªæ˜¯å…¶ä¸­çš„ä¸€ä¸ªåˆ†æ”¯

æˆ‘ä»¬æ¥çœ‹çœ‹ FuflfillPromiseReactionJob å…·ä½“åšäº†å“ªäº›äº‹æƒ…ã€‚

### FuflfillPromiseReactionJob

æºç å¦‚ä¸‹ï¼š

```
transitioning
macro FuflfillPromiseReactionJob(
    context: Context,
    promiseOrCapability: JSPromise|PromiseCapability|Undefined, result: JSAny,
    reactionType: constexpr PromiseReactionType): JSAny {
  typeswitch (promiseOrCapability) {
    case (promise: JSPromise): {
      // è°ƒç”¨ ResolvePromiseï¼Œä¹Ÿå°±æ˜¯ promise çš„ resolve(result)
      return ResolvePromise(context, promise, result);
    }
    case (Undefined): {
      return Undefined;
    }
    case (capability: PromiseCapability): {
      const resolve = UnsafeCast<Callable>(capability.resolve);
      try {
        return Call(context, resolve, Undefined, result);
      } catch (e) {
        return RejectPromiseReactionJob(
            context, promiseOrCapability, e, reactionType);
      }
    }
  }
}
å¤åˆ¶ä»£ç 
```

FuflfillPromiseReactionJob æœ‰ 3 ä¸ªåˆ†æ”¯ï¼Œè¿™é‡Œèµ°çš„æ˜¯ç¬¬ä¸€ä¸ªåˆ†æ”¯ï¼Œè°ƒç”¨ [ResolvePromise](https://link.juejin.cn?target=https%3A%2F%2Fchromium.googlesource.com%2Fv8%2Fv8.git%2F%2B%2Frefs%2Fheads%2F9.0-lkgr%2Fsrc%2Fbuiltins%2Fpromise-resolve.tq%2388 "https://chromium.googlesource.com/v8/v8.git/+/refs/heads/9.0-lkgr/src/builtins/promise-resolve.tq#88")ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦ï¼Œä»–æ˜¯è§„èŒƒä¸­çš„ [Promise Resolve Functions](https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-promise-resolve-functions "https://262.ecma-international.org/11.0/#sec-promise-resolve-functions")ï¼Œä»–çš„ä½œç”¨æ˜¯åŒæ­¥å½“å‰å¤„ç†å‡½æ•°çš„ç»“æœï¼ˆå€¼å’ŒçŠ¶æ€ï¼‰ç»™å…¶äº§ç”Ÿçš„ promsieã€‚promiseOrCapabilityã€‚

> ä¸Šé¢ä¾‹å­ä¸­ promiseOrCapability å°±æ˜¯ p1, å€¼æ˜¯ 2

### ResolvePromiseï¼ˆé‡è¦ï¼‰

è¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„æ–¹æ³•ï¼ŒåŸºæœ¬ä¸Šæ¯ä¸€ä¸ª Promise çš„çŠ¶æ€éœ€è¦å˜æˆ fulfilled éƒ½ä¼šè°ƒç”¨å®ƒï¼Œå®ƒçš„é€»è¾‘ä¹Ÿäº§ç”Ÿäº†è®¸å¤š PromiseA+ ä¸­æ²¡æœ‰çš„ç‰¹æ€§ã€‚ ä¸‹é¢çš„ä»£ç æˆ‘åˆ é™¤äº†ä¸é‡è¦çš„éƒ¨åˆ†

```
// https://tc39.es/ecma262/#sec-promise-resolve-functions
transitioning builtin
ResolvePromise(implicit context: Context)(
    promise: JSPromise, resolution: JSAny): JSAny {
	// åˆ 
  let then: Object = Undefined;
  try {
    // è°ƒç”¨ FulfillPromise
    const heapResolution = UnsafeCast<HeapObject>(resolution);
    const resolutionMap = heapResolution.map;
    if (!IsJSReceiverMap(resolutionMap)) {
      return FulfillPromise(promise, resolution);
    }
   	// åˆ 
    const promisePrototype =
        *NativeContextSlot(ContextSlot::PROMISE_PROTOTYPE_INDEX);
    // é‡è¦ï¼šå¦‚æœ resolution æ˜¯ä¸€ä¸ª Promise å¯¹è±¡
    if (resolutionMap.prototype == promisePrototype) {
      then = *NativeContextSlot(ContextSlot::PROMISE_THEN_INDEX);
      static_assert(nativeContext == LoadNativeContext(context));
      goto Enqueue;
    }
    goto Slow;
  } label Slow deferred {
    // å¦‚æœ resolution æ˜¯ä¸€ä¸ªåŒ…å«thenå±æ€§çš„å¯¹è±¡ï¼Œä¼šæ¥åˆ°è¿™
    try {
      // è·å– then å±æ€§
      then = GetProperty(resolution, kThenString);
    } catch (e) {
      return RejectPromise(promise, e, False);
    }
    // å¦‚æœ then å±æ€§ä¸æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„æ–¹æ³•
    if (!Is<Callable>(then)) {
      // å°†æ‰§è¡Œç»“æœåŒæ­¥åˆ° promise
      return FulfillPromise(promise, resolution);
    }
    goto Enqueue;
  } label Enqueue {
    // é‡è¦ï¼šå¦‚æœ æ‰§è¡Œç»“æœæ˜¯ä¸€ä¸ª Promise å¯¹è±¡
    // æˆ–è€…åŒ…å«å¯æ‰§è¡Œçš„ then æ–¹æ³•çš„å¯¹è±¡ï¼Œä¼šæ¥åˆ°è¿™
    const task = NewPromiseResolveThenableJobTask(
        promise, UnsafeCast<JSReceiver>(resolution),
        UnsafeCast<Callable>(then));
    return EnqueueMicrotask(task.context, task);
  }
}
å¤åˆ¶ä»£ç 
```

ResolvePromise æ–¹æ³•ä¸­æœ‰å‡ ä¸ªå¾ˆé‡è¦çš„é€»è¾‘ï¼Œä¸€ä¸ªæ˜¯è°ƒç”¨ FulfillPromiseï¼Œè¿™ä¸ªåœ¨ resolve çš„æ—¶å€™å·²ç»ä»‹ç»è¿‡äº†ï¼Œä½œç”¨æ˜¯ä¿®æ”¹ promise çš„çŠ¶æ€ä¸º fulfilled å¹¶ä¸ºå…¶è®¾ç½®å€¼ï¼Œç„¶åå°† promise çš„å¤„ç†å‡½æ•°æ¨åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

```
let p0 = Promise.resolve()
let p1 = p0.then(() => {
  return 1;
})

p1.then(console.log)

// p0 then ä¸­ onFulfilled å›è°ƒè¿›å…¥é˜Ÿåˆ—
// PromiseReactionJob ä¸­è°ƒç”¨ p0 çš„ onFulfilled ï¼Œå¾—åˆ°ç»“æœä¸º1
// è°ƒç”¨ FuflfillPromiseReactionJob ï¼Œç„¶åè°ƒç”¨ ResolvePromise
// ResolvePromise åšå¦‚ä¸‹æ“ä½œ
// å°† p1 å˜æˆ fulfilled, å¹¶å°† p1 çš„å¤„ç†å‡½æ•° console.log åŠ åˆ°é˜Ÿåˆ—ï¼Œå‚æ•°ä¸º 1
// p1 çš„ onFulfilled å‡ºé˜Ÿåˆ—æ‰§è¡Œï¼Œè¾“å‡º 1
å¤åˆ¶ä»£ç 
```

è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ **å½“ resolution çš„å€¼æ˜¯ä¸€ä¸ª Promise å¯¹è±¡æˆ–è€…æ˜¯ä¸€ä¸ªåŒ…å« then æ–¹æ³•çš„å¯¹è±¡æ—¶ã€‚ä¼šè°ƒç”¨ NewPromiseResolveThenableJobTask ç”Ÿæˆä¸€ä¸ª microtaskï¼Œç„¶åå°†å…¶åŠ å…¥ microtask é˜Ÿåˆ—ä¸­ã€‚**

```
let p0 = Promise.resolve()
// ä¸¤ç§ç‰¹æ®Šæƒ…å†µ
let p1 = p0.then(() => {
  return Promise.resolve(1);// è¿”å›å€¼æ˜¯ Promise å¯¹è±¡
})
let p2 = p0.then(() => {
  return {then(resolve, reject){resolve(1)};// è¿”å›å€¼åŒ…å« then æ–¹æ³•
})

p1.then(console.log)
å¤åˆ¶ä»£ç 
```

### NewPromiseResolveThenableJobTaskï¼ˆé‡è¦ï¼‰

NewPromiseResolveThenableJobTask çš„ç›®çš„æ˜¯è°ƒç”¨ resolution çš„ then æ–¹æ³•ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­åŒæ­¥çŠ¶æ€ç»™ promiseã€‚ è¿™å¯èƒ½ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œæˆ‘æŠŠä»–è½¬åŒ–ä¸º js æ¥å¤§è‡´å°±æ˜¯è¿™æ ·çš„ã€‚

```
microtask(() => {
  resolution.then((value) => {
    ReslovePromise(promise, value) 
  })
})
å¤åˆ¶ä»£ç 
```

è¿™ä¸ªä»»åŠ¡ä¸­ä¼šè°ƒç”¨ resolution.then ï¼Œç„¶ååŒæ­¥åˆ° promsieã€‚ä½†æ˜¯è¿™ä¸ªæ•´ä½“çš„è¿‡ç¨‹éœ€è¦åŠ å…¥ microtask é˜Ÿåˆ—ä¸­ç­‰å¾…è¿è¡Œï¼Œå½“è¿™ä¸ªä»»åŠ¡è¿è¡Œæ—¶ï¼Œå¦‚æœ resolution ä¹Ÿæ˜¯ä¸€ä¸ª Promise çš„è¯ï¼Œåˆ™ `(value) => {ReslovePromise(promise, value) }` åˆä¼šè¢«ä½œä¸ºä¸€ä¸ª microtask åŠ å…¥ microtask é˜Ÿåˆ—ä¸­ç­‰å¾…è¿è¡Œã€‚

ä½ å¯ä»¥ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿä¸ºä»€ä¹ˆä¸åŒæ­¥è°ƒç”¨ `resolution.then((value) => {ReslovePromise(promise, value) })`ï¼Œè€Œæ˜¯æŠŠä»–å°è£…ä¸ºä¸€ä¸ª microtask å‘¢ï¼Ÿæˆ‘ä¸€å¼€å§‹ä¹Ÿæ„Ÿåˆ°ç–‘æƒ‘ï¼Œå¥½åœ¨è§„èŒƒä¸­ç»™å‡ºäº†ä¸€ä¸ªåŸå› ã€‚

> æ³¨æ„: æ­¤ä½œä¸šä½¿ç”¨æä¾›çš„ thenable åŠå…¶ then æ–¹æ³•æ¥è§£å†³ç»™å®šçš„ Promiseã€‚ æ­¤è¿‡ç¨‹å¿…é¡»ä½œä¸ºä½œä¸šè¿›è¡Œï¼Œä»¥ç¡®ä¿åœ¨å¯¹ä»»ä½•å‘¨å›´ä»£ç çš„è¯„ä¼°å®Œæˆåå¯¹ then æ–¹æ³•è¿›è¡Œè¯„ä¼°ã€‚
> 
> å¼•è‡³ [ECMAScript NewPromiseResolveThenableJobTask è§„èŒƒ](https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F%23sec-newpromisereactionjob "https://262.ecma-international.org/11.0/#sec-newpromisereactionjob") (ä½œè€…ç¿»è¯‘)

> **ä»€ä¹ˆæ˜¯ thenableï¼š**
> 
> Javascript ä¸ºäº†è¯†åˆ« Promise äº§ç”Ÿçš„ä¸€ä¸ªæ¦‚å¿µï¼Œç®€å•æ¥è¯´å°±æ˜¯æ‰€æœ‰åŒ…å« then æ–¹æ³•çš„å¯¹è±¡éƒ½æ˜¯ thenableã€‚

ã€ä»¥ç¡®ä¿åœ¨å¯¹ä»»ä½•å‘¨å›´ä»£ç çš„è¯„ä¼°å®Œæˆåå¯¹ then æ–¹æ³•è¿›è¡Œè¯„ä¼°ã€æŒ‡çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘å”¯ä¸€èƒ½æƒ³åˆ°çš„å°±æ˜¯ä¸‹é¢è¿™ç§æƒ…å†µã€‚

```
const p1 = new Promise((resolve, reject) => {
    const p2 = Promise.resolve().then(() => {
        resolve({
            then: (resolve, reject) => resolve(1)
        });
        const p3 = Promise.resolve().then(() => console.log(2));
    });
}).then(v => console.log(v));
// 2 1
å¤åˆ¶ä»£ç 
```

ä¸Šé¢ p2 çš„ onFulfilled å›è°ƒ ä¼šå…ˆè¿›å…¥ microtask é˜Ÿåˆ—ï¼Œç­‰å¾…å…¶æ‰§è¡Œæ—¶ è°ƒç”¨ p1 çš„ resolveï¼Œä½†æ˜¯å‚æ•°æ˜¯ä¸€ä¸ªåŒ…å« then æ–¹æ³•çš„å¯¹è±¡ã€‚è¿™æ—¶ p1 ä¸ä¼šç«‹å³æ”¹å˜ä¸º fulfilledï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ª microtask æ¥æ‰§è¡Œè¿™ä¸ª then æ–¹æ³•ï¼Œç„¶åå°† p2 çš„ onFulfilled åŠ å…¥ microtask é˜Ÿåˆ—ã€‚è¿™æ—¶ microtask é˜Ÿåˆ—ä¸­æœ‰ä¸¤ä¸ª microtaskï¼Œä¸€ä¸ªæ˜¯æ‰§è¡Œ resolve è¿”å›å€¼ä¸­çš„ then å‡½æ•°ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ p3 çš„ onFulfilled å‡½æ•°ã€‚

ç„¶åå–å‡ºç¬¬ä¸€ä¸ª microtask æ‰§è¡Œï¼ˆå–å‡ºå microtask é˜Ÿåˆ—ä¸­åªå‰©ä¸‹ p3 çš„ onFulfilledï¼‰ï¼Œæ‰§è¡Œå p1 çš„çŠ¶æ€å˜ä¸º fulfilledï¼Œç„¶å p1 çš„ onFulfilled è¿›å…¥é˜Ÿåˆ—ã€‚åé¢å¯æƒ³è€ŒçŸ¥æ˜¯ç›¸ç»§è¾“å‡º 2 å’Œ 1ï¼ˆå› ä¸º p1 çš„ onFulfilled å‡½æ•°åœ¨ p3 çš„ onFulfilled å‡½æ•°ä¹‹åè¿›å…¥ microtask é˜Ÿåˆ—ï¼‰ã€‚

å¦‚æœæ²¡æœ‰å°† NewPromiseResolveThenableJobTask ä½œä¸ºä¸€ä¸ª microtaskã€‚ä¹Ÿå°±å˜æˆäº† p2.then ä¸­çš„å›è°ƒæ‰§è¡Œæ—¶åŒæ­¥è§¦å‘ resolve å‚æ•°ä¸­çš„ then æ–¹æ³•ï¼Œfulfilled çš„çŠ¶æ€ä¼šç«‹å³åŒæ­¥åˆ° p1, è¿™æ—¶ p1 çš„ onFulfilled å°±ä¼šå…ˆè¿›å…¥ microtaskï¼Œå¯¼è‡´ç»“æœå˜ä¸º 12ã€‚è¿™æ ·çš„æ‰§è¡Œç»“æœå¯ä»¥ä¼šè®© JavaScript å¼€å‘è€…æ„Ÿåˆ°ç–‘æƒ‘ã€‚

æ‰€ä»¥ ECMAScript å°†å…¶ä½œä¸ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡æ¥æ‰§è¡Œã€‚

> ä¼¼ä¹ è¿”å› Promsie å¯¹è±¡ä¼šäº§ç”Ÿä¸¤ä¸ª microtask ä¼¼ä¹ä¼šæ›´è®©äººæ„Ÿåˆ°ç–‘æƒ‘ã€‚

### RejectPromiseReactionJob

PromiseReactionJob ä¸­å¦‚æœå¤„ç†å‡½æ•° handler æ‰§è¡Œæ—¶æŠ›å‡ºå¼‚å¸¸åˆ™ä¼šæ‰§è¡Œ RejectPromiseReactionJobï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢è¿™ç§æƒ…å†µ

```
let p0 = Promise.resolve()
let p1 = p0.then(() => {
    throw 'error'; // handler æ‰§è¡Œæ—¶å‡ºé”™
})
å¤åˆ¶ä»£ç 
```

è¿™æ˜¯ä¼šè°ƒç”¨ RejectPromiseReactionJobï¼Œå…¶æºç å¦‚ä¸‹

```
macro RejectPromiseReactionJob(
    context: Context,
    promiseOrCapability: JSPromise|PromiseCapability|Undefined, reason: JSAny,
    reactionType: constexpr PromiseReactionType): JSAny {
  if constexpr (reactionType == kPromiseReactionReject) {
    typeswitch (promiseOrCapability) {
      case (promise: JSPromise): {
// promiseOrCapability å°±æ˜¯ p1ï¼Œæ˜¯ä¸€ä¸ª Promise å¯¹è±¡
// æ‰§è¡Œ RejectPromiseï¼Œè°ƒç”¨ p1 çš„ reject æ–¹æ³•
        return RejectPromise(promise, reason, False);
      }
      case (Undefined): {
        return Undefined;
      }
      case (capability: PromiseCapability): {
        const reject = UnsafeCast<Callable>(capability.reject);
        return Call(context, reject, Undefined, reason);
      }
    }
  } else {
    StaticAssert(reactionType == kPromiseReactionFulfill);
    return PromiseRejectReactionJob(reason, Undefined, promiseOrCapability);
  }
}
å¤åˆ¶ä»£ç 
```

RejectPromiseReactionJob ä¸ FuflfillPromiseReactionJob æ˜¯ç±»ä¼¼çš„ï¼Œå°±æ˜¯è°ƒç”¨ RejectPromise æ¥è°ƒç”¨ Promsie çš„ reject æ–¹æ³•ï¼Œè¿™ä¸ªåœ¨ä¸Šé¢ reject çš„åœ°æ–¹ä»‹ç»è¿‡äº†ã€‚

### PromiseReactionJob çš„ handler == Undefined åˆ†æ”¯

PromiseReactionJob ä¸­è¿˜æœ‰ä¸€ä¸ª handler == Undefined çš„åˆ†æ”¯ä¹Ÿå¾ˆé‡è¦ï¼Œå½“ä¸€ä¸ª task ä¸­çš„ handler ä¸º undefined æ—¶ä¼šè¿›å…¥è¿™ä¸ªåˆ†æ”¯ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œè¿™é‡Œå†è´´ä¸€ä¸‹ä»£ç 

```
transitioning
macro PromiseReactionJob(
    context: Context, argument: JSAny, handler: Callable|Undefined,
    promiseOrCapability: JSPromise|PromiseCapability|Undefined,
    reactionType: constexpr PromiseReactionType): JSAny {
  if (handler == Undefined) {
    // æ²¡æœ‰å¤„ç†å‡½æ•°çš„ caseï¼Œé€ä¼ ä¸Šä¸€ä¸ª Promise çš„ argument
    if constexpr (reactionType == kPromiseReactionFulfill) {
      // åŸºæœ¬ç±»åŒ JS å±‚çš„ resolve
      return FuflfillPromiseReactionJob(
          context, promiseOrCapability, argument, reactionType);
    } else {
      // åŸºæœ¬ç±»åŒ JS å±‚çš„ reject
      return RejectPromiseReactionJob(
          context, promiseOrCapability, argument, reactionType);
    }
  } else {
    // åˆ é™¤
  }
}
å¤åˆ¶ä»£ç 
```

è¿›å…¥åˆ†æ”¯åä¼šç›´æ¥è·å–ä¸Šä¸€ä¸ª Promise å¯¹è±¡çš„ value å’Œ çŠ¶æ€ åŒæ­¥åˆ°å½“å‰ promise æ¥ï¼Œæˆ‘ä»¬æ¥é€šè¿‡ä¸€æ®µ js äº†è§£ä»–

```
let p0 = new Promise((resolve, reject) => {
    reject(123)
})
// p0 çš„çŠ¶æ€ä¸º rejected

let p1 = p0.then(_ => {console.log('p0 onFulfilled')})
// p0 çš„ onRejected ä½œä¸º handler è¿›å…¥ microtask é˜Ÿåˆ—
// ä½†æ˜¯å› ä¸º then æ²¡æœ‰ä¼ é€’ç¬¬äºŒä¸ªå‚æ•°
// æ‰€ä»¥ onRejected æ˜¯ undefinedï¼Œé‚£ä¹ˆ handler ä¹Ÿæ˜¯ undefined

let p2 = p1.then(_ => {console.log('p1 onFulfilled')})
/*
ä¸ºp1ç»‘å®š 
PromiseReaction{
  onFulfilled:_ => {console.log('p1 onFulfilled')}, 
  onRejected:undefined
}
*/
let p3 = p2.then(_ => {console.log('p2 onFulfilled')}, _ => {console.log('p2 onRejected')})
/*
ä¸ºp2ç»‘å®š 
PromiseReaction{
  onFulfilled:_ => {console.log('p2 onFulfilled')}, 
  onRejected:_ => {console.log('p2 onRejected')
}
*/
let p4 = p3.then(_ => {console.log('p3 onFulfilled')}, _ => {console.log('p3 onRejected')})
/*
ä¸ºp3ç»‘å®š 
PromiseReaction{
  onFulfilled:_ => {console.log('p3 onFulfilled')}, 
  onRejected:_ => {console.log('p3 onRejected')
}
*/

//p2 onRejected
//p3 onFulfilled
å¤åˆ¶ä»£ç 
```

åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•åï¼ˆæ‰§è¡Œè¿‡ç¨‹å¤§è‡´å¦‚æ³¨é‡Šï¼‰, å¼€å¯å– microtask æ‰§è¡Œï¼Œæ­¤æ—¶ microtask é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ª handler ä¸º undefined çš„ä»»åŠ¡ã€‚è¿›å…¥ PromiseReactionJob çš„ handler == Undefined åˆ†æ”¯ã€‚

å› ä¸ºæ­¤æ—¶ p0 çŠ¶æ€ä¸º rejectedï¼Œæ‰€ä»¥æ‰§è¡Œ `RejectPromiseReactionJob(context, promiseOrCapability, argument, reactionType)`ï¼Œå…¶ä¸­ promiseOrCapability å°±æ˜¯ p1, argument å°±æ˜¯ p0 çš„å€¼ 123ï¼ŒreactionType ä¸º rejectedã€‚

æ‰§è¡Œå p0 çš„çŠ¶æ€ä¹Ÿå˜ä¸º reactionType ä¹Ÿå°±æ˜¯ rejectedï¼Œp1 çš„å€¼ä¸º argumentï¼ˆç›¸å½“äºå§ p0 çš„çŠ¶æ€å’Œå€¼éƒ½è½¬ç§»åˆ°äº† p1ï¼‰ã€‚

ç„¶åæ‰§è¡Œ p1 çš„ reject å‡½æ•°ï¼ˆ`FulfillPromise(p1, 123)`ï¼‰ï¼Œä¼šå§ p1 ç»‘å®šçš„ PromiseReaction é“¾è¡¨ä¸­çš„ onRejectedï¼ˆè¿˜æ˜¯ undefinedï¼‰ å½“åš handler è¿›å…¥ microtask é˜Ÿåˆ—ï¼ˆå› ä¸º p1 çš„çŠ¶æ€æ˜¯ rejectedï¼Œæ‰€ä»¥æ˜¯ onRejectedï¼‰

åŒæ ·è¿˜æ˜¯å– microtask ä»»åŠ¡æ‰§è¡Œï¼Œhandler è¿˜æ˜¯ undefinedï¼Œåé¢å°±å’Œä¸Šé¢ä¸€æ ·ï¼ŒæŠŠçŠ¶æ€ rejected å’Œå€¼ 123 ç»§ç»­åŒæ­¥ç»™ p2ï¼Œ..........

å†æ¬¡å– microtask æ‰§è¡Œï¼Œå› ä¸º p2 ç»‘å®šäº† onRejected å‡½æ•°ï¼Œæ‰€ä»¥ handler ä¸æ˜¯ undefinedï¼Œåˆ™ä¸èµ° handler == Undefined åˆ†æ”¯ï¼Œå¦ä¸€ä¸ªåˆ†æ”¯çš„é€»è¾‘åˆšåˆšå·²ç»æè¿°è¿‡äº†ã€‚å¤§æ¦‚å°±æ˜¯æ‰§è¡Œ onRejected(123)ï¼Œç„¶åå°†å…¶ç»“æœè®¾ç½®åˆ° p3 çš„ valueï¼Œp3 å˜ä¸º fulfilled çŠ¶æ€ã€‚

> è¾“å‡º p2 onRejected

å› ä¸º onRejected(123) çš„è¿”å›å€¼æ˜¯ undefinedï¼Œæ‰€ä»¥ p3 å˜ä¸º fulfilled çŠ¶æ€ï¼Œä¸”å€¼ä¸º undefined

åé¢è¿˜æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ handler å°±æ˜¯ onFulfilled äº†ï¼Œå› ä¸º p3 çš„çŠ¶æ€æ˜¯ fulfilled å˜›ï¼Œè¿™é‡Œå°±ç›¸å½“äº `onFulfilled(undefined)`(å› ä¸º p3 çš„å€¼çš„ undefined)ã€‚

> è¾“å‡º p3 onFulfilled

è€Œå p4 çš„çŠ¶æ€ä¹Ÿå˜æˆäº† fulfilledï¼Œå€¼ä¹Ÿæ˜¯ undefinedï¼Œå› ä¸º p3 çš„ onFulfilled è¿”å›å€¼æ˜¯ undefined

ç„¶å p4 çš„ onFulfilled å˜æˆ handler é˜Ÿåˆ—ï¼Œå› ä¸º p4 æ²¡æœ‰è°ƒç”¨ then ç»‘å®šè¿‡ onFulfilled å¤„ç†å‡½æ•°ã€‚ä½†æ˜¯å› ä¸ºæ²¡æœ‰è°ƒç”¨ then æ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰äº§ç”Ÿæ–°çš„ Promsie å¯¹è±¡ï¼Œè¿™æ¬¡åœ¨æ‰§è¡Œ FuflfillPromiseReactionJob æ–¹æ³•çš„æ—¶å€™è¿›å…¥ promiseOrCapability ä¸º Undefined åˆ†æ”¯å°±ç»“æŸäº†

è‡³æ­¤æ‰€æœ‰ç›¸å…³çš„ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆ

å¦‚æœä¸Šé¢ä½ çœ‹æ‡‚äº†ï¼Œé‚£ä¹ˆä¸‹é¢è¿™æ®µä»£ç æˆ‘æƒ³ä½ ä¹Ÿåº”è¯¥èƒ½çŸ¥é“ç»“æœ

```
Promise.resolve('123')
    .then(() => {throw new Error('456')})
    .then(_ => {
        console.log('shouldnot be here')
    })
    .catch((e) => console.log(e))
    .then((data) => console.log(data));
å¤åˆ¶ä»£ç 
```

> catch(onRejected) çš„æœ¬è´¨æ˜¯ then(undefined, onRejected)

è¿™å°±æ˜¯ Promise çš„ rejected ä¼ é€’æœºåˆ¶ï¼Œä¸æ–­å‘ä¸‹ä¼ é€’ç›´åˆ°é‡è§ onRejected å¤„ç†å‡½æ•°ä¸ºæ­¢

Promise çš„å‡ ä¸ªé«˜éš¾åº¦é¢˜ç›®
----------------

### é¢˜ç›® 1

```
Promise.resolve().then(() => {
    console.log(0);
    return Promise.resolve(4);
}).then((res) => {
    console.log(res)
})

Promise.resolve().then(() => {
    console.log(1);
}).then(() => {
    console.log(2);
}).then(() => {
    console.log(3);
}).then(() => {
    console.log(5);
}).then(() => {
    console.log(6);
})
// 0 1 2 3 4 5 6
å¤åˆ¶ä»£ç 
```

> ä¸»è¦è€ƒå¯Ÿ å½“ Promise çš„å€¼æ˜¯ promsie å¯¹è±¡æ—¶ä¼šå¦‚ä½•å¤„ç†ï¼Œåœ¨æœ¬æ–‡ çš„ **then çš„é“¾å¼è°ƒç”¨ä¸ microtask é˜Ÿåˆ—** > **ResolvePromise** ç›®å½•æœ«å°¾å¤„å¼€å§‹ä»‹ç»
> 
> å…³é”®å­—ï¼š**thenable**ã€**NewPromiseResolveThenableJobTask**

**é¢˜è§£**

ä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„ä»£ç è½¬åŒ–ä¸ºä¸‹é¢è¿™æ ·

```
let p1 = Promise.resolve()
let p2 = p1.then(() => {
    console.log(0);
    let p3 = Promise.resolve(4)
    return p3;
})
let p4 = p2.then((res) => {
    console.log(res)
})

let p5 = Promise.resolve()
let p6 = p5.then(() => {
    console.log(1);
})
let p7 = p6.then(() => {
    console.log(2);
})
let p8 = p7.then(() => {
    console.log(3);
})
let p9 = p8.then(() => {
    console.log(5);
})
let p10 = p9.then(() => {
    console.log(6);
})
å¤åˆ¶ä»£ç 
```

å…ˆæ‰§è¡Œæ‰€æœ‰çš„åŒæ­¥ä»£ç ï¼Œæ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹é¢çš„æ³¨é‡Š

```
let p1 = Promise.resolve()
// 1. p1 çš„çŠ¶æ€ä¸º fulfilled

let p2 = p1.then(() => {
    console.log(0);
    let p3 = Promise.resolve(4)
    return p3;
})
// 2. å› ä¸º p1 çš„çŠ¶æ€å·²ç»æ˜¯ fulfilledï¼Œæ‰€ä»¥è°ƒç”¨ then åç«‹å³å°† onFulfilled æ”¾å…¥ microtask é˜Ÿåˆ—
// æ­¤æ—¶ microtask åªæœ‰p1çš„ onFulfilledï¼š [p1.onFulfilled]

let p4 = p2.then((res) => {
    console.log(res)
})
// 3. p2çš„çŠ¶æ€è¿˜æ˜¯ pendingï¼Œæ‰€ä»¥è°ƒç”¨ then åæ˜¯ä¸º p2 æ”¶é›†ä¾èµ–ï¼Œæ­¤æ—¶ p2 çš„ reactions å¦‚ä¸‹
/*{
    onFulfilled: (res) => {console.log(res)},
    onRejected: undefined
}*/


let p5 = Promise.resolve()
// 4. p5 çš„çŠ¶æ€ä¸º fulfilled

let p6 = p5.then(() => {
    console.log(1);
})
// 5. åŒç¬¬2æ­¥ï¼Œå°† onFulfilled åŠ å…¥ microtask é˜Ÿåˆ—
// æ­¤æ—¶ microtask æ˜¯ï¼š [p1.onFulfilled, p5.onFulfilled]

let p7 = p6.then(() => {
    console.log(2);
})
// 6. åŒç¬¬3æ­¥ï¼Œæ˜¯ç»™ p6 æ·»åŠ  reactions

let p8 = p7.then(() => {
    console.log(3);
})
// 7. åŒä¸Šï¼Œæ˜¯ç»™ p7 æ·»åŠ  reactions

let p9 = p8.then(() => {
    console.log(5);
})
// 8. åŒä¸Šï¼Œæ˜¯ç»™ p8 æ·»åŠ  reactions

let p10 = p9.then(() => {
    console.log(6);
})
// 9. åŒä¸Šï¼Œæ˜¯ç»™ p9 æ·»åŠ  reactions
å¤åˆ¶ä»£ç 
```

10.  å½“åŒæ­¥ä»£ç æ‰§è¡Œå®Œæˆåï¼Œmicrotask é˜Ÿåˆ—åªæœ‰

```
[p1.onFulfilled, p5.onFulfilled]
å¤åˆ¶ä»£ç 
```

11.  ç„¶åå–å‡º p1.onFulfilled æ¥æ‰§è¡Œï¼Œæ­¤æ—¶è¾“å‡º `0`ï¼Œä½†æ˜¯å‘ç° p1.onFulfilled è¿”å›å€¼çš„ p3 æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ã€‚æ‰€ä»¥ä¼šæ‰§è¡Œ ResolvePromise çš„ Enqueue ä»£ç å—ï¼Œé‡Œé¢ä¼šè°ƒç”¨ NewPromiseResolveThenableJobTask äº§ç”Ÿä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œè¿™ä¸ªå¾®ä»»åŠ¡çš„è¦åšçš„äº‹æƒ…ä¸Šé¢å·²ç»ä»‹ç»è¿‡ï¼Œå¤§è‡´å°±æ˜¯ä¸‹é¢è¿™æ ·

```
let promiseResolveThenableJobTask = () => {
    p3.then((value) => { // p3çš„valueæ˜¯4
        ReslovePromise(p2, value) 
    })
}
å¤åˆ¶ä»£ç 
```

ç„¶åå°†å…¶åŠ å…¥ microtask é˜Ÿåˆ—ï¼Œ è¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆäº† :

```
[p5.onFulfilled, promiseResolveThenableJobTask]
å¤åˆ¶ä»£ç 
```

12.  ç»§ç»­å–å‡º p5.onFulfilled æ‰§è¡Œï¼Œæ­¤æ—¶è¾“å‡º `1`ï¼Œå› ä¸º p5.onFulfilled è¿”å›å€¼æ˜¯ undefinedï¼Œæ‰€ä»¥å°±å°† undefined ä½œä¸º p6 çš„å€¼ï¼Œç„¶åå°† p6 çš„çŠ¶æ€å˜ä¸º fulfilledã€‚

å› ä¸º p6 çš„çŠ¶æ€è¢«æ”¹å˜ï¼Œæ‰€ä»¥å®ƒçš„ reactions ä¹Ÿä¼šåŠ å…¥ microtask é˜Ÿåˆ—ï¼Œè¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆè¿™æ ·ï¼š

```
[promiseResolveThenableJobTaskï¼Œp6.onFulfilled]
å¤åˆ¶ä»£ç 
```

13.  åŒæ ·æ˜¯å– promiseResolveThenableJobTask æ‰§è¡Œï¼Œå› ä¸º promiseResolveThenableJobTask çš„å†…å®¹æ˜¯ä¸‹é¢è¿™æ ·

```
let promiseResolveThenableJobTask = () => {
    p3.then((value) => { 
        ReslovePromise(p2, value) // ReslovePromise çš„ä½œç”¨ä¸Šé¢æœ‰ä»‹ç»
    })
}
å¤åˆ¶ä»£ç 
```

æ‰€ä»¥æ‰§è¡Œ promiseResolveThenableJobTask æ—¶å°±ç›¸å½“äºæ‰§è¡Œäº† `p3.then((value) => {ReslovePromise(p2, value)})`

å› ä¸º p3 çš„çŠ¶æ€æ˜¯ fulfilled ï¼Œæ‰€ä»¥ä¼šå°†å…¶ onFulfilled åŠ å…¥ microtask é˜Ÿåˆ—ï¼ˆvalue å‚æ•°å°±æ˜¯ p3 çš„å€¼ 4ï¼Œååºä»–å°†ä¼ é€’ç»™ p2ï¼‰ï¼Œè¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆè¿™æ ·ï¼š

```
[p6.onFulfilledï¼Œp3.onFulfilled]
å¤åˆ¶ä»£ç 
```

14.  åŒæ ·æ˜¯å– p6.onFulfilled æ‰§è¡Œï¼Œç„¶åè¾“å‡º `2` å¹¶å°†å…¶è¿”å›å€¼ undefined è®¾ç½®ä¸º p7 çš„å€¼ï¼Œå¹¶å°† p7 å˜ä¸º fulfilled çŠ¶æ€ï¼Œæ‰€ä»¥ p7 çš„ reactions ä¹Ÿä¼šåŠ å…¥ microtask é˜Ÿåˆ—ï¼Œè¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆè¿™æ ·ï¼š

```
[p3.onFulfilledï¼Œp7.onFulfilled]
å¤åˆ¶ä»£ç 
```

15.  p3.onFulfilled å‡ºé˜Ÿæ‰§è¡Œï¼Œp3.onFulfilled æ˜¯ `(value) => {ReslovePromise(p2, value)}`, å‚æ•° value æ˜¯ 4ï¼Œæ‰€ä»¥æ­¤æ—¶å°±æ‰§è¡Œ `ReslovePromise(p2, 4)`, è¿™å°±ç›¸å½“äºè°ƒç”¨äº† p2 çš„ resolveã€‚

æ‰€ä»¥æ­¤æ—¶ p2 çš„ å€¼å˜ä¸º 4ï¼Œ çŠ¶æ€ä¸ºå˜ fulfilledï¼Œç„¶åå°†å…¶ reactions æŒ¨ä¸ªåŠ å…¥ microtask é˜Ÿåˆ—ï¼Œè¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆè¿™æ ·ï¼š

```
[p7.onFulfilledï¼Œp2.onFulfilled]
å¤åˆ¶ä»£ç 
```

16.  p7.onFulfilled å‡ºé˜Ÿåˆ—æ‰§è¡Œï¼Œè¾“å‡º `3`ï¼Œp8 çŠ¶æ€å˜ä¸º fulfilleï¼Œå€¼å˜ä¸º undefinedï¼Œç„¶å p8.onFulfilled åŠ å…¥é˜Ÿåˆ—

```
[p2.onFulfilledï¼Œp8.onFulfilled]
å¤åˆ¶ä»£ç 
```

17.  p2.onFulfilled å‡ºé˜Ÿåˆ—æ‰§è¡Œï¼Œè¾“å‡º `4`ï¼Œå› ä¸º p2 æ²¡æœ‰è¢«åœ¨æ­¤è°ƒç”¨ then æ–¹æ³•ï¼Œæ‰€ä»¥å°±æ²¡æœ‰äº§ç”Ÿä¸‹ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰ååºäº†ã€‚

```
[p8.onFulfilled]
å¤åˆ¶ä»£ç 
```

18.  åé¢å°±ä¸ç”¨è¯´äº†

### é¢˜ç›® 2

```
Promise.resolve().then(() => {
    console.log(0);
    return {then(resolve){resolve(4)}};
}).then((res) => {
    console.log(res)
})

Promise.resolve().then(() => {
    console.log(1);
}).then(() => {
    console.log(2);
}).then(() => {
    console.log(3);
}).then(() => {
    console.log(5);
}).then(() => {
    console.log(6);
})
// 0 1 2 4 3 5 6
å¤åˆ¶ä»£ç 
```

> ä¸ä¸Šé¢˜çŸ¥è¯†ç‚¹ä¸€è‡´ï¼Œè€ƒå¯Ÿçš„æ˜¯ Promise çš„å€¼æ˜¯ä¸€ä¸ªåŒ…å« then æ–¹æ³•çš„å¯¹è±¡æ—¶å‘ç”Ÿçš„é€»è¾‘
> 
> å…³é”®å­—ï¼š**thenable**ã€**NewPromiseResolveThenableJobTask**

### é¢˜ç›® 3

```
const p1 = new Promise((resolve, reject) => {
    reject(0)
})
console.log(1);
setTimeout(() => {
    p1.then(undefined, console.log)
}, 0)
console.log(2);
// 1
// 2
// è¾“å‡ºæŠ¥é”™ UnhandledPromiseRejection: This error originated either

const p1 = new Promise((resolve, reject) => {
    reject(0)
})
console.log(1);
p1.then(undefined, console.log)
console.log(2);
// 1
// 2
// 0
å¤åˆ¶ä»£ç 
```

> ä¸ºä»€ä¹ˆç¬¬ä¸€ç§æ–¹å¼ä¼šæŠ¥é”™ï¼Ÿ
> 
> è€ƒå¯Ÿçš„æ˜¯è§„èŒƒä¸­çš„ HostPromiseRejectionTrackerï¼Œå½“ä¸€ä¸ªæ²¡æœ‰ç»‘å®šå¤„ç†å‡½æ•°çš„ Promsie è¢«è°ƒç”¨ reject åˆ™ä¼šåˆ›å»ºä¸€ä¸ª å¾®ä»»åŠ¡æ¥å†æ¬¡æ£€æµ‹è¿™ä¸ª Promise æ˜¯å¦å­˜åœ¨å¤„ç†å‡½æ•°ï¼Œå¦‚æœæ­¤æ—¶è¿˜ä¸å­˜åœ¨åˆ™è¾“å‡ºæŠ¥é”™ï¼ŒsetTimeout å›è°ƒæ‰§è¡Œåœ¨å¾®ä»»åŠ¡ä¹‹åã€‚
> 
> æœ¬æ–‡ **reject** > **HostPromiseRejectionTracker** ç›®å½•å¤„æœ‰è¯¦ç»†ä»‹ç»ã€‚

> **æ³¨æ„ï¼š** æµè§ˆå™¨æ§åˆ¶å°æœ‰ä¸€ä¸ªéå¸¸å¥‡æ€ªçš„ç‰¹æ€§ï¼Œå¦‚æœåœ¨è¿™ä¸ªé”™è¯¯è¾“å‡ºååœ¨ä¸ºå…¶ç»‘å®š onrejected å¤„ç†å‡½æ•°ï¼Œæµè§ˆå™¨ä¼šå°†æ§åˆ¶å°çš„é”™è¯¯è¦†ç›–æ‰ã€‚æ‰€ä»¥å¦‚æœä½ åœ¨æµè§ˆå™¨æ‰§è¡Œè¿™æ®µä»£ç ï¼Œè¯·å°† setTimeout çš„æ—¶é—´è®¾ç½®é•¿ä¸€ç‚¹ï¼Œè¿™æ ·æ•ˆæœæ›´åŠ å®¹æ˜“è‚‰çœ¼å¯è§ã€‚

### é¢˜ç›®å››

ä¸ºä»€ä¹ˆ async1 end è¾“å‡ºåœ¨ promise3 ä¹‹åï¼Ÿ

```
async function async1() { 
    console.log("async1 start"); 
    await async2(); 
    console.log("async1 end"); 
} 
async function async2() { 
    console.log("async2"); 
    return Promise.resolve().then(() => { 
        console.log("async2-inner"); 
    }); 
} 

console.log("script start"); 
setTimeout(function () { 
    console.log("settimeout"); 
}); 

async1(); 
new Promise(function (resolve) { 
    console.log("promise1"); 
    resolve(); 
}) 
.then(function () { 
    console.log("promise2"); 
}) 
.then(function () { 
    console.log("promise3"); 
}) 
.then(function () { 
    console.log("promise4"); 
}); 
console.log("script end");
å¤åˆ¶ä»£ç 
```

> æ„Ÿè°¢è¯„è®ºåŒºè´¡çŒ®çš„é¢˜ç›®

**é¢˜è§£**

è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œé¢æ¶‰åŠ async ä¸­ä½¿ç”¨ await ä¼šäº§ç”Ÿå¤šä¸ª Promise é“¾è·¯çš„é—®é¢˜ä»¥åŠ resolve å€¼ä¸º Promise å¯¹è±¡çš„é—®é¢˜ï¼Œé‡ç‚¹çœ‹ async2ï¼Œæˆ‘æŠŠä»–è½¬åŒ–ä¸ºè¿™æ ·ï¼ˆsetTimeout å¯¹äºæœ¬é¢˜æ‚¬å¿µä¸å¤§ï¼Œå°±åˆ é™¤äº†ï¼‰ã€‚

```
async function async1() {
    console.log("async1 start");
    let a2 = async2();
    await a2
    console.log("async1 end");
}
async function async2() {
    console.log("async2");
    let p1 = Promise.resolve()
    let p2 = p1.then(() => {
        console.log("async2-inner");
    })
    return p2;
}

let a1 = async1();

let p3 = new Promise(function (resolve) {
    console.log("promise1");
    resolve();
})

let p4 = p3.then(function () {
    console.log("promise2");
})
// ä¸º p3 æ·»åŠ  reactions
let p5 = p4.then(function () {
    console.log("promise3");
})
// ä¸º p4 æ·»åŠ  reactions
let p6 = p5.then(function () {
    console.log("promise4");
});
// ä¸º p5 æ·»åŠ  reactions
console.log("script end");
å¤åˆ¶ä»£ç 
```

æƒ³å¿…ä½ ä¹Ÿå‘ç°äº† async å‡½æ•°ä¸­ await è¯­å¥ä¹‹å‰çš„ä»£ç éƒ½æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼ˆç›¸å½“äº Promsie çš„ executorï¼‰

1.  å…ˆè°ƒç”¨ async1ï¼Œè¾“å‡º `async1 start`ï¼Œ åŒæ­¥æ‰§è¡Œåˆ° `async2()` çš„ä½ç½®ï¼Œç„¶åå»åŒæ­¥æ‰§è¡Œ async2ã€‚

ç„¶åè¾“å‡º `async2`ï¼Œé‡Œé¢åˆ›å»ºä¸€ä¸ª fulfilled çŠ¶æ€çš„ p1ï¼Œç„¶åä¸º p1 ç»‘å®š thenï¼Œå› ä¸º p1 æ˜¯ fulfilled çŠ¶æ€æ‰€ä»¥ p1.onFulfilled ä¼šç«‹å³è¿›å…¥ microtask é˜Ÿåˆ—ã€‚è¿™æ—¶ microtask é˜Ÿåˆ—å°±å˜æˆè¿™æ ·ï¼š

```
[p1.onFulfilled]
å¤åˆ¶ä»£ç 
```

ç„¶åè¿”å› p2ï¼ˆresolve(p2)ï¼‰ï¼Œåˆå› ä¸º p2 æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªå¦‚ä¸‹çš„ promiseResolveThenableJobTask

```
let promiseResolveThenableJobTask = () => {
    p2.then((value) => { 
        ReslovePromise(a2, value) // ReslovePromise çš„ä½œç”¨ä¸Šé¢æœ‰ä»‹ç»
    })
}
å¤åˆ¶ä»£ç 
```

```
[p1.onFulfilledï¼ŒpromiseResolveThenableJobTask]
å¤åˆ¶ä»£ç 
```

2.  ç„¶åæ‰§è¡Œ await a2ï¼Œè¿™é‡Œå¾ˆå…³é”®ï¼Œawait ä¼šç­‰å¾…ä¸€ä¸ª Promsie è¿›å…¥ fulfilled çŠ¶æ€åæ‰æ‰§è¡Œåé¢çš„ä»£ç ï¼Œå…¶å®å°±ç›¸å½“äºä¸‹é¢è¿™æ ·

```
a2.then(_ => {
	// è¿™é‡Œæ˜¯ async1 ä¸­ await åçš„ä»£ç 
})
// ä¸º a2 ç»‘å®šäº† reactionsï¼Œè¿™é‡Œçš„ onFulfill æš‚æ—¶å°±å« ã€async1ååŠæ®µã€å§
// å…¶å®è¿™é‡Œé¢åšçš„äº‹æƒ…å¾ˆå¤šï¼Œæˆ‘åé¢å¯èƒ½ä¼šå•ç‹¬è®²è§£ async/await çš„åŸç†
å¤åˆ¶ä»£ç 
```

æ³¨æ„æ­¤æ—¶ a2 è¿˜ä¸æ˜¯ fulfilled çŠ¶æ€ï¼Œå› ä¸ºä»–éœ€è¦ç­‰å¾… promiseResolveThenableJobTask æ‰§è¡Œæ—¶æ¥è°ƒç”¨ä»–çš„ resolve æ‰ä¼šå˜æˆ fulfilledã€‚

3.  è¿™æ—¶ async1() è§¦å‘çš„åŒæ­¥ä»£ç æ‰æ‰§è¡Œå®Œæ¯•ï¼Œç»§ç»­æ‰§è¡Œåé¢çš„ new Promise

åŒæ­¥æ‰§è¡Œè¿™æ®µä»£ç 

```
function (resolve) {
    console.log("promise1");
    resolve();
}
å¤åˆ¶ä»£ç 
```

è¾“å‡º `promise1`, æ‰§è¡Œ resolveï¼Œ ç„¶å p3 çŠ¶æ€å˜ä¸º fulfilledï¼Œp3.onFulfilled è¿›å…¥é˜Ÿåˆ—ï¼Œåé¢çš„ then éƒ½æ˜¯ç»™å¯¹åº”çš„ promsie ç»‘å®š reactions è¿™ä¸ªå°±ä¸è¯´äº†ï¼Œæœ€åè¾“å‡º `script end`

åˆ°æ­¤æ—¶æ‰€æœ‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œæˆï¼Œ microtask é˜Ÿåˆ—æ˜¯è¿™æ ·çš„ï¼š

```
[p1.onFulfilledï¼ŒpromiseResolveThenableJobTaskï¼Œp3.onFulfilled]
å¤åˆ¶ä»£ç 
```

4.  è‡³æ­¤æ‰€æœ‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œæˆï¼Œå¼€å§‹å– microtask æ‰§è¡Œï¼Œé¦–å…ˆæ˜¯ p1.onFulfilleed ï¼Œæ‰§è¡Œè¾“å‡º `async2-inner`, ç„¶å å°†å…¶è¿”å›å€¼ undefined ä½œä¸º p2 çš„å€¼ï¼Œå¹¶å°† p2 å˜æˆ fulfilled çŠ¶æ€ã€‚å› ä¸º p2 æ­¤æ—¶æ²¡æœ‰ reactions ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰è¢«è°ƒç”¨è¿‡ then æ–¹æ³•ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šå‘ç”Ÿä»€ä¹ˆäº‹æƒ…

```
[promiseResolveThenableJobTaskï¼Œp3.onFulfilled]
å¤åˆ¶ä»£ç 
```

5.  promiseResolveThenableJobTask å‡ºé˜Ÿåˆ—æ‰§è¡Œï¼Œ å…¶å†…å®¹å¦‚ä¸‹ï¼Œä¸Šé¢å·²ç»è¯´è¿‡äº†

```
let promiseResolveThenableJobTask = () => {
    p2.then((value) => { 
        ReslovePromise(a2, value) // ReslovePromise çš„ä½œç”¨ä¸Šé¢æœ‰ä»‹ç»
    })
}
å¤åˆ¶ä»£ç 
```

æ‰§è¡Œæ˜¯æ‰§è¡Œ p2 çš„ then æ–¹æ³•ä¸ºå…¶ç»‘å®š onFulfilled å¤„ç†å‡½æ•°ï¼Œä½†æ˜¯ p2 å·²ç»æ˜¯ fulfilled çŠ¶æ€ï¼Œæ‰€ä»¥ä¼šç›´æ¥å°† p2.onFulfilled åŠ å…¥ microtask é˜Ÿåˆ—ã€‚

```
[p3.onFulfilled, p2.onFulfilled]
å¤åˆ¶ä»£ç 
```

6.  p3.onFulfilled å‡ºé˜Ÿæ‰§è¡Œï¼Œè¾“å‡º `promise2` ï¼Œå°† p4 çš„çŠ¶æ€å˜ä¸º fulfilledï¼Œp4 çš„å€¼ä¸ºå…¶ 1 è¿”å›å€¼ä¹Ÿå°±æ˜¯ undefinedï¼Œç„¶å p4 çš„ onFulfilled ä¹Ÿä¼šåŠ å…¥ microtask é˜Ÿåˆ—

```
[p2.onFulfilled, p4.onFulfilled]
å¤åˆ¶ä»£ç 
```

7.  p2.onFulfilled å‡ºé˜Ÿåˆ—æ‰§è¡Œï¼Œ p2.onFulfilled çš„å†…å®¹å¦‚ä¸‹ï¼Œè¿™ä¸ªä¸Šé¢è¯´è¿‡

```
(value) => { 
    ReslovePromise(a2, value) // ä¹Ÿå°±æ˜¯ a2 çš„ resolve(value)
}
å¤åˆ¶ä»£ç 
```

æ‰€ä»¥æ‰§è¡Œ ReslovePromise åï¼Œa2 ä¼šå˜æˆ fulfilled çŠ¶æ€ï¼Œa2.onFulfilled ä¹Ÿå°±æ˜¯ ã€async1 ååŠæ®µã€ ä¹Ÿç†æ‰€å½“ç„¶çš„è¿›å…¥ microtask é˜Ÿåˆ—

```
[p4.onFulfilled, async1ååŠæ®µ]
å¤åˆ¶ä»£ç 
```

8.  åé¢çš„ç»“æœå°±æ²¡æœ‰ä»€ä¹ˆéš¾ç‚¹äº†ï¼Œp4.onFulfilled å‡ºé˜Ÿæ‰§è¡Œï¼Œè¾“å‡º `promise3`ï¼Œç„¶å p5.onFulfilled å…¥é˜Ÿ

```
[async1ååŠæ®µ,p5.onFulfilled]
å¤åˆ¶ä»£ç 
```

9.  async1 ååŠæ®µ å‡ºé˜Ÿæ‰§è¡Œï¼Œè¾“å‡º `async1 end`ï¼Œ ç„¶å a1 çŠ¶æ€å˜ä¸º fulfilledï¼Œä½†æ˜¯æ²¡æœ‰ç»‘å®šä»»ä½•å¤„ç†å‡½æ•°ï¼Œæ‰€ä»¥ a1 å°±æ²¡æœ‰åç»­äº†

```
[p5.onFulfilled]
å¤åˆ¶ä»£ç 
```

10.  p5.onFulfilled å‡ºé˜Ÿæ‰§è¡Œè¾“å‡º `promise4`ï¼ŒåŒç† p6 æ²¡æœ‰ç»‘å®šä»»ä½•å¤„ç†å‡½æ•°ï¼Œè‡³æ­¤æ‰€æœ‰ä»£ç æ‰§è¡Œå®Œæˆ

### æœ€åå‡ ä»¶äº‹

1.  å¦‚æœå¯¹æœ¬æ–‡æœ‰ä»»ä½•é—®é¢˜è¯·è¯„è®ºç•™è¨€
    
2.  å¦‚æœä½ å›é¡¾äº†æœ¬æ–‡è¿˜æ˜¯æ— æ³•å¾—åˆ°ä¸Šè¿°é¢˜ç›®çš„ç­”æ¡ˆï¼Œè¯·è¯„è®ºåŒºå‘ŠçŸ¥ï¼Œæˆ‘ååºä¼šç»™å‡ºè¯¦ç»†çš„æ‰§è¡Œè¿‡ç¨‹ä»‹ç»
    
3.  å¦‚æœä½ æœ‰ä»»ä½• Promise é—®é¢˜ï¼Œå¯è¯„è®ºï¼Œä½œè€…å…è´¹æ‰¿åŒ…æ‰€æœ‰ Promise é—®é¢˜
    
4.  å¦‚æœä½ çœ‹åˆ°äº†è¿™é‡Œå´è¿˜æ²¡æœ‰ç‚¹èµï¼Œè¯·ç‚¹èµï¼Œéå¸¸æ„Ÿè°¢ã€‚
    

ç›¸å…³é“¾æ¥
----

[Promise V8 æºç åˆ†æ (ä¸€)â€”â€”å¾é¹è·ƒ](https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F264944183 "https://zhuanlan.zhihu.com/p/264944183")

[promise.then ä¸­ return Promise.resolve åï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ](https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F453677175%2Fanswer%2F1841325386 "https://www.zhihu.com/question/453677175/answer/1841325386")

[Chromium Code Search](https://link.juejin.cn?target=https%3A%2F%2Fsource.chromium.org%2Fchromium%2Fchromium%2Fsrc "https://source.chromium.org/chromium/chromium/src")

[ECMA-262, 11th edition, June 2020](https://link.juejin.cn?target=https%3A%2F%2F262.ecma-international.org%2F11.0%2F "https://262.ecma-international.org/11.0/")